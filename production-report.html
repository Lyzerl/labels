<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×“×•×— ×™×™×¦×•×¨ ×—× - 4 ×™××™×</title>
<!-- PWA Meta Tags -->
<meta name="theme-color" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="×‘×™×§ ×”×–×× ×•×ª">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">
<!-- Preconnect ×œ×˜×¢×™× ×” ××”×™×¨×” -->
<link rel="preconnect" href="https://priority-proxy.lyzer-64d.workers.dev" crossorigin>
<!-- × ×™×•×•×˜ ××©×•×ª×£ -->
<script src="js/nav.js" defer></script>
<!-- CSS ××©×•×ª×£ -->
<link rel="stylesheet" href="css/styles.css">
<!-- ×¡×’× ×•× ×•×ª ×¡×¤×¦×™×¤×™×™× ×œ×“×£ -->
<style>
.container { max-width: 1400px; padding: 20px; }
h1 { margin-bottom: 20px; }

.date-range-info {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
    font-size: 1.1em;
}

.date-range-info strong {
    font-size: 1.2em;
}

.day-table-container {
    margin-bottom: 40px;
    page-break-inside: avoid;
}

.day-title {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    color: white;
    padding: 15px 25px;
    border-radius: 10px 10px 0 0;
    font-size: 1.3em;
    font-weight: bold;
    text-align: center;
}

.section-title {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    padding: 10px 20px;
    font-size: 1.1em;
    font-weight: bold;
    text-align: center;
    margin-top: 15px;
}

.section-title.gastronorm {
    background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
}

.report-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95em;
}

.report-table th, .report-table td {
    border: 2px solid #333;
    padding: 10px 8px;
    text-align: center;
}

.report-table th {
    background: #4285f4;
    color: white;
    font-weight: bold;
    font-size: 1em;
}

.report-table th.product-col {
    background: #2c3e50;
    min-width: 200px;
    text-align: right;
    padding-right: 15px;
}

.report-table td.product-name {
    background: #ecf0f1;
    font-weight: bold;
    text-align: right;
    padding-right: 15px;
    cursor: pointer;
    transition: background 0.2s;
}

.report-table td.product-name:hover {
    background: #d5dbdb;
    text-decoration: underline;
}

.report-table td.total-row {
    background: #f39c12;
    font-weight: bold;
    color: #fff;
}

.report-table tr:hover td:not(.product-name):not(.total-row) {
    background: #fff3e0;
}

.report-table td {
    background: #fafafa;
}

.controls {
    justify-content: flex-start;
}

.actions-bar {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-bottom: 25px;
}

.summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 12px;
    text-align: center;
}

.summary-card.hot {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
}

.summary-card.gastronorm {
    background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
}

.summary-card h3 {
    margin: 0 0 8px 0;
    font-size: 0.85em;
    opacity: 0.9;
}

.summary-card .value {
    font-size: 1.6em;
    font-weight: bold;
}

.branch-filter {
    display: flex;
    align-items: center;
    gap: 10px;
}

.branch-filter label {
    font-weight: bold;
}

.branch-filter select {
    padding: 10px 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1em;
    min-width: 150px;
}

/* Modal styles */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-overlay.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 15px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.2em;
    color: white;
}

.modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background 0.2s;
}

.modal-close:hover {
    background: rgba(255,255,255,0.3);
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-item {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.modal-item:last-child {
    border-bottom: none;
}

.modal-item strong {
    color: #333;
    font-size: 1em;
}

.modal-item span {
    color: #666;
    font-size: 0.9em;
}

.modal-item:hover {
    background: #f8f9fa;
}

@media print {
    body { background: white; padding: 5px; }
    .container { box-shadow: none; max-width: 100%; padding: 10px; }
    .main-nav, .actions-bar, #status, .modal-overlay { display: none !important; }
    .report-table { font-size: 0.8em; }
    .report-table th, .report-table td { padding: 6px 4px; }
    .summary-cards { display: none; }
    h1 { font-size: 1.3em; margin-bottom: 10px; }
    .date-range-info { padding: 8px; font-size: 0.9em; margin-bottom: 15px; }
    .day-table-container { margin-bottom: 25px; page-break-inside: avoid; }
    .day-title { padding: 10px; font-size: 1.1em; }
    .section-title { padding: 8px; font-size: 1em; }
    .report-table td.product-name { cursor: default; }
    .report-table td.product-name:hover { background: #ecf0f1; text-decoration: none; }
}

@media (max-width: 768px) {
    .report-table { font-size: 0.75em; }
    .report-table th, .report-table td { padding: 5px 3px; }
    .summary-cards { grid-template-columns: repeat(2, 1fr); }
    .actions-bar { flex-direction: column; align-items: stretch; }
}
</style>
</head>
<body>

<div class="container">
    <!-- ×ª×¤×¨×™×˜ × ×™×•×•×˜ ××©×•×ª×£ -->
    <nav id="main-nav"></nav>

    <h1>ğŸ”¥ ×“×•×— ×™×™×¦×•×¨ ×—× - 4 ×™××™ ×¢×‘×•×“×” ×§×“×™××”</h1>

    <div id="dateRangeInfo" class="date-range-info">
        ×˜×•×¢×Ÿ ×ª××¨×™×›×™×...
    </div>

    <div class="actions-bar">
        <div class="branch-filter">
            <label for="branchSelect">×¡× ×™×£:</label>
            <select id="branchSelect">
                <option value="all">×”×›×œ</option>
                <option value="south">×“×¨×•×</option>
                <option value="north">×¦×¤×•×Ÿ</option>
            </select>
        </div>
        <button class="btn" onclick="loadReport()" id="loadBtn">ğŸ”„ ×˜×¢×Ÿ ×“×•×—</button>
        <button class="btn download" onclick="printReport()" id="printBtn" disabled>ğŸ–¨ï¸ ×”×“×¤×¡</button>
        <button class="btn download" onclick="downloadCSV()" id="csvBtn" disabled>ğŸ“¥ ×”×•×¨×“ CSV</button>
    </div>

    <div id="status"></div>

    <div id="summaryCards" class="summary-cards" style="display: none;"></div>

    <div id="reportContainer"></div>
</div>

<!-- Modal for showing order details -->
<div id="itemModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">×¤×¨×˜×™ ×”×–×× ×•×ª</h2>
            <button class="modal-close" onclick="closeItemModal()">âœ• ×¡×’×•×¨</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Content will be inserted here -->
        </div>
    </div>
</div>

<!-- ×˜×¢×™× ×ª ×§×•× ×¤×™×’×•×¨×¦×™×” ××©×•×ª×¤×ª -->
<script src="js/config.js"></script>
<script>
// ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
let reportData = null;
let workingDays = [];
let allDaysDataGlobal = []; // ×©××™×¨×ª ×”× ×ª×•× ×™× ×œ×›×œ ×”×™××™×
let productOrdersData = {}; // ×©××™×¨×ª ×”×”×–×× ×•×ª ×œ×›×œ ××•×¦×¨ ×‘×›×œ ×™×•×

// ×—×™×©×•×‘ 4 ×™××™ ×¢×‘×•×“×” ×§×“×™××” (×¨××©×•×Ÿ ×¢×“ ×—××™×©×™) - ××ª×—×™×œ×™× ××”×™×•× ×”×‘×
function calculateWorkingDays() {
    const days = [];
    const today = new Date();
    let currentDate = new Date(today);

    // ××ª×—×™×œ×™× ××”×™×•× ×”×‘× (×œ× ×›×•×œ×œ ×”×™×•×)
    currentDate.setDate(currentDate.getDate() + 1);

    while (days.length < 4) {
        const dayOfWeek = currentDate.getDay(); // 0 = ×¨××©×•×Ÿ, 6 = ×©×‘×ª

        // ×™××™× 0-4 ×”× ×¨××©×•×Ÿ ×¢×“ ×—××™×©×™ (×™××™ ×¢×‘×•×“×”)
        if (dayOfWeek >= 0 && dayOfWeek <= 4) {
            days.push(new Date(currentDate));
        }

        // ×¢×•×‘×¨×™× ×œ×™×•× ×”×‘×
        currentDate.setDate(currentDate.getDate() + 1);
    }

    return days;
}

// ×¤×•×¨××˜ ×ª××¨×™×š ×œ×¢×‘×¨×™×ª
function formatDateHebrew(date) {
    const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
    const dayName = days[date.getDay()];
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `×™×•× ${dayName} ${day}/${month}/${year}`;
}

// ×¤×•×¨××˜ ×ª××¨×™×š ×§×¦×¨
function formatDateShort(date) {
    const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
    const dayName = days[date.getDay()];
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    return `×™×•× ${dayName} (${day}/${month})`;
}

// ×¤×•×¨××˜ ×ª××¨×™×š ×œ-API
function formatDateForAPI(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×˜×•×•×— ×”×ª××¨×™×›×™×
function updateDateRangeDisplay() {
    workingDays = calculateWorkingDays();
    const infoDiv = document.getElementById('dateRangeInfo');

    if (workingDays.length >= 4) {
        const firstDate = formatDateHebrew(workingDays[0]);
        const lastDate = formatDateHebrew(workingDays[3]);
        infoDiv.innerHTML = `<strong>×˜×•×•×— ×ª××¨×™×›×™×:</strong> ${firstDate} ×¢×“ ${lastDate}`;
    }
}

// ××©×™×›×ª × ×ª×•× ×™× ××”×©×¨×ª
async function fetchDataForDate(date, branch) {
    const dateStr = formatDateForAPI(date) + 'T00:00:00Z';
    let filter = `$filter=DUEDATE eq ${dateStr}`;

    // ×”×•×¡×¤×ª ×¤×™×œ×˜×¨ ×¡× ×™×£
    if (branch === 'south') {
        filter += ` and BRANCHNAME le '1'`;
    } else if (branch === 'north') {
        filter += ` and BRANCHNAME ge '3'`;
    }

    const url = `${PROXY_URL}?filter=${encodeURIComponent(filter)}&fetchAll=true`;

    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`×©×’×™××ª ×©×¨×ª: ${response.status}`);
    }

    const data = await response.json();
    return data.value || data;
}

// ×¡×™× ×•×Ÿ ×¨×§ ×¤×¨×™×˜×™× ×—××™× - ××©×ª××© ×‘×¤×•× ×§×¦×™×” ×-DEFINITIONS ×©×‘×•×“×§×ª ×›×œ ×”×©×“×•×ª ×”×¨×œ×•×•× ×˜×™×™×
function filterHotItems(data) {
    return data.filter(row => {
        // ××©×ª××©×™× ×‘×¤×•× ×§×¦×™×” isHotItem ×-DEFINITIONS ×©×‘×•×“×§×ª:
        // CARTON_TYPE, PSPEC6, PSPEC3
        return DEFINITIONS.isHotItem(row);
    });
}

// ×¢×™×‘×•×“ ×”× ×ª×•× ×™× ×œ×˜×‘×œ×” ××¡×›××ª - ×œ×™×•× ××—×“
// ××¤×¨×™×“ ×‘×™×Ÿ: ×’×¡×˜×¨×•× ×•×, ×××¨×–×™× (5 ×•-7), ××™×›×œ×™× ×¨×’×™×œ×™×, ×—××’×©×™×•×ª
// ×—×©×•×‘:
// - ×× ××•×ª×• ××•×¦×¨ ×‘××•×ª×” ×”×–×× ×” ×¢× ×›××” ×©×•×¨×•×ª (×¡×•×’×™ ××¨×™×–×”) - ×¡×•×¤×¨ ×¤×¢× ××—×ª
// - ×× ××•×ª×• ××•×¦×¨ ×‘××•×ª×” ×”×–×× ×” ×‘×›××” ××¨×•×—×•×ª - ×¡×•×¤×¨ ×›×œ ××¨×•×—×” ×‘× ×¤×¨×“
// - ×× ××•×ª×• ××•×¦×¨ ××›××” ×”×–×× ×•×ª - ××¡×›× ×™×—×“ ×‘×˜×‘×œ×”
// - ×‘×¡× ×™×£ ×“×¨×•×: ×’×¡×˜×¨×•× ×•× ×¢× ×××¨×–×™× 5/7 ××¡×•×›× ×™×—×“ ×¢× ×”×××¨×–×™×
function processDataForDay(dayData, dayIndex, branch = 'all') {
    const isSouthBranch = (branch === 'south');

    // ×©×œ×‘ 1: ××™×—×•×“ ×©×•×¨×•×ª ×œ×¤×™ ×”×–×× ×”+××•×¦×¨+××¨×•×—×”
    // ××¤×ª×— ×™×™×—×•×“×™ = ORDNAME + PARTDES + MEALNAME (×›×œ ××¨×•×—×” × ×¡×¤×¨×ª ×‘× ×¤×¨×“)
    const uniqueItems = {};

    dayData.forEach(row => {
        const productName = String(row.PARTDES || '').trim();
        if (!productName) return;

        const orderName = String(row.ORDNAME || '');
        const mealName = String(row.MEALNAME || '');
        // ××¤×ª×— ×™×™×—×•×“×™ ×›×•×œ×œ ××¨×•×—×” - ×›×œ ××¨×•×—×” × ×¡×¤×¨×ª ×‘× ×¤×¨×“
        const uniqueKey = `${orderName}|${productName}|${mealName}`;

        // ×× ×›×‘×¨ ×¨××™× ×• ××ª ×”×©×™×œ×•×‘ ×”×–×” - ××“×œ×’×™×
        if (uniqueItems[uniqueKey]) return;

        // ×©×•××¨×™× ××ª ×”×©×•×¨×” ×”×¨××©×•× ×” ×©×œ ×”×©×™×œ×•×‘ ×”×–×”
        uniqueItems[uniqueKey] = row;
    });

    // ×©×œ×‘ 2: ×¢×™×‘×•×“ ×”× ×ª×•× ×™× ×”×××•×—×“×™×
    // ××•×¦×¨×™ ×’×¡×˜×¨×•× ×•× - × ×¤×¨×“
    const gastronormProducts = {};
    // ××•×¦×¨×™ ×××¨×–×™× (5 ×•-7) - ×œ×œ× ××™×›×œ×™×
    const packProducts = {};
    // ××•×¦×¨×™ ××™×›×œ×™× ×¨×’×™×œ×™× - ×¨×§ ×× ××™×Ÿ ×××¨×–×™×
    const containerProducts = {};
    // ×—××’×©×™×•×ª
    const trayProducts = {};

    Object.values(uniqueItems).forEach(row => {
        const productName = String(row.PARTDES || '').trim();

        const orderName = row.ORDNAME || '';
        const mealName = row.MEALNAME || '';

        // ×‘×“×™×§×” ×× ×–×” ×—××’×©×™×ª ××œ×¨×’× ×™×ª - ××“×œ×’×™× ×¢×œ×™×”
        const pspec2 = String(row.PSPEC2 || '').toLowerCase();
        const spec2 = String(row.SPEC2 || '').toLowerCase();
        const packMethod = String(row.PACKMETHODCODE || '').toLowerCase();
        const isTray = packMethod.includes('×—××’×©×™×ª');
        const isAllergen = pspec2.includes('××œ×¨×’× ') || spec2.includes('××œ×¨×’× ');

        // ××“×œ×’×™× ×¢×œ ×—××’×©×™×•×ª ××œ×¨×’× ×™×•×ª
        if (isTray && isAllergen) return;

        // ×–×™×”×•×™ ×©×™×˜×ª ××¨×™×–×” ×’×¡×˜×¨×•× ×•×
        const isGastronorm = packMethod.includes('×’×¡×˜×¨×•× ×•×');

        // ×‘×“×™×§×” ×× ×–×” ×œ×§×•×— ×—×‘"×“ ×¢× ×× ×” ×¢×™×§×¨×™×ª ×‘×©×¨×™×ª - ××ª×™×™×—×¡×™× ×›×ª×¤×–×•×¨×ª
        // PSPEC3 ××›×™×œ ××ª ×”×¤×¨××˜×¨ ×©×œ ×‘×©×¨×™/×¤×¨×•×•×”
        const pspec3 = String(row.PSPEC3 || '').toLowerCase();
        const isChabad = spec2.includes('×—×‘×“') || spec2.includes('×—×‘"×“');
        const isMeatMain = pspec3.includes('×‘×©×¨×™');
        const isChabadMeatTray = isChabad && isMeatMain && isTray;

        // ×©××™×¨×ª ×¤×¨×˜×™ ×”×”×–×× ×” ×œ×¤×•×¤××¤
        const orderKey = `${dayIndex}_${productName}`;
        if (!productOrdersData[orderKey]) {
            productOrdersData[orderKey] = [];
        }

        // ×‘×“×™×§×” ×× ×”×”×–×× ×”+××¨×•×—×” ×›×‘×¨ ×§×™×™××ª
        const existingOrder = productOrdersData[orderKey].find(o =>
            o.orderName === orderName && o.mealName === mealName
        );
        if (!existingOrder) {
            productOrdersData[orderKey].push({
                orderName: orderName,
                mealName: mealName,
                custDes: row.CUSTDES || '',
                custName: row.CUSTNAME || '',
                quantity: parseFloat(row.TQUANT) || 0,
                eatQuant: parseFloat(row.EATQUANT) || 0
            });
        }

        // ×—×™×©×•×‘ ×”×¢×¨×›×™×
        const tquant = parseFloat(row.TQUANT) || 0;
        const eatQuant = parseFloat(row.EATQUANT) || 0;
        const param7 = parseFloat(row.Y_9964_5_ESH) || 0;
        const param8 = parseFloat(row.Y_9965_5_ESH) || 0;

        // ×‘×“×™×§×” ×× ×™×© ×¤×¨××˜×¨ 8 (×××¨×–×™×)
        const hasPacks = param8 > 0;

        // ×—××’×©×™×•×ª - × ×¤×¨×“ (××œ× ×× ×–×” ×—×‘"×“ ×¢× ×× ×” ×‘×©×¨×™×ª - ××– ××ª×™×™×—×¡×™× ×›×ª×¤×–×•×¨×ª)
        // ×—×©×•×‘: ×—××’×©×™×•×ª ×œ× × ×¡×¤×¨×•×ª ×‘×××¨×–×™× ×’× ×‘×“×¨×•×!
        if (isTray && !isAllergen && !isChabadMeatTray) {
            if (!trayProducts[productName]) {
                trayProducts[productName] = { name: productName, trays: 0 };
            }
            trayProducts[productName].trays += eatQuant;
            return; // ×—××’×©×™×•×ª ×œ× × ×¡×¤×¨×•×ª ×‘××™×›×œ×™×/×××¨×–×™×
        }

        // ×—×‘"×“ ×¢× ×× ×” ×‘×©×¨×™×ª ×‘×—××’×©×™×ª - ××ª×™×™×—×¡×™× ×›×ª×¤×–×•×¨×ª (×××©×™×›×™× ×œ×‘×“×™×§×•×ª ×”×‘××•×ª)

        // ×‘×¡× ×™×£ ×“×¨×•×: ×›×œ ×¤×¨×™×˜ ×¢× ×××¨×–×™× (×—×•×¥ ××—××’×©×™×ª ×©×›×‘×¨ ×˜×•×¤×œ×” ×œ××¢×œ×”) - ××¡×•×›× ×‘×××¨×–×™×
        // ×–×” ×›×•×œ×œ ×’× ×¤×¨×™×˜×™× ×‘×©×™×˜×ª ××¨×™×–×” ×’×¡×˜×¨×•× ×•×!
        if (isSouthBranch && hasPacks) {
            if (!packProducts[productName]) {
                packProducts[productName] = { name: productName, pack5: 0, pack7: 0, packWeight: 0 };
            }
            // ×—×™×©×•×‘ ×××¨×–×™×
            if (tquant > 0) {
                const totalServings = Math.ceil(tquant / param8);
                const optimized = DEFINITIONS.calculateOptimalPacks(totalServings);
                packProducts[productName].pack5 += optimized.five;
                packProducts[productName].pack7 += optimized.seven;
                packProducts[productName].packWeight += tquant;
            }
            return; // ×¡×•×›× ×‘×××¨×–×™×
        }

        // ×’×¡×˜×¨×•× ×•× (×‘×¦×¤×•×Ÿ ××• ×‘×œ×™ ×××¨×–×™×) - × ×¤×¨×“
        if (isGastronorm) {
            if (!gastronormProducts[productName]) {
                gastronormProducts[productName] = { name: productName, containers: 0, weight: 0 };
            }
            // ×—×™×©×•×‘ ××™×›×œ×™ ×’×¡×˜×¨×•× ×•×
            let containers = 0;
            if (tquant > 0 && param7 > 0) {
                const divisionResult = tquant / param7;
                containers = Math.ceil(divisionResult / 6.5);
            }
            gastronormProducts[productName].containers += containers;
            gastronormProducts[productName].weight += tquant;
            return; // ×’×¡×˜×¨×•× ×•× ×œ× × ×¡×¤×¨ ×‘×××¨×–×™×/××™×›×œ×™× ×¨×’×™×œ×™×
        }

        if (hasPacks) {
            // ×××¨×–×™× 5 ×•-7
            if (!packProducts[productName]) {
                packProducts[productName] = { name: productName, pack5: 0, pack7: 0, packWeight: 0 };
            }
            // ×—×™×©×•×‘ ×××¨×–×™×
            if (tquant > 0) {
                const totalServings = Math.ceil(tquant / param8);
                const optimized = DEFINITIONS.calculateOptimalPacks(totalServings);
                packProducts[productName].pack5 += optimized.five;
                packProducts[productName].pack7 += optimized.seven;
                packProducts[productName].packWeight += tquant;
            }
        } else {
            // ××™×›×œ×™× ×¨×’×™×œ×™× - ×¨×§ ×× ××™×Ÿ ×××¨×–×™×
            if (!containerProducts[productName]) {
                containerProducts[productName] = { name: productName, containers: 0, weight: 0 };
            }
            // ×—×™×©×•×‘ ××™×›×œ×™×
            let containers = 0;
            if (tquant > 0 && param7 > 0) {
                const divisionResult = tquant / param7;
                containers = Math.ceil(divisionResult / 2); // ××™×›×œ ×¨×’×™×œ - ×—×™×œ×•×§ ×‘-2
            }
            containerProducts[productName].containers += containers;
            containerProducts[productName].weight += tquant;
        }
    });

    return {
        gastronorm: gastronormProducts,
        packs: packProducts,
        containers: containerProducts,
        trays: trayProducts
    };
}

// ×¤×ª×™×—×ª ×¤×•×¤××¤ ×”×–×× ×•×ª
function openItemModal(productName, dayIndex) {
    const modal = document.getElementById('itemModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    if (!modal || !modalTitle || !modalBody) return;

    const safeProductName = String(productName || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    const dayDate = workingDays[dayIndex] ? formatDateHebrew(workingDays[dayIndex]) : '';
    modalTitle.textContent = `×”×–×× ×•×ª - ${safeProductName}`;

    const orderKey = `${dayIndex}_${productName}`;
    const ordersData = productOrdersData[orderKey];

    let html = '';

    if (ordersData && ordersData.length > 0) {
        // ×›×•×ª×¨×ª ×¢× ×”×ª××¨×™×š
        html += `<div style="background:#e3f2fd;padding:10px;border-radius:5px;margin-bottom:15px;text-align:center;font-weight:bold;">${dayDate}</div>`;

        // ××™×•×Ÿ ×œ×¤×™ ×©× ×œ×§×•×—
        const sortedOrders = ordersData.sort((a, b) => {
            const nameA = String(a.custDes || '').trim();
            const nameB = String(b.custDes || '').trim();
            return nameA.localeCompare(nameB, 'he');
        });

        sortedOrders.forEach(order => {
            const orderName = String(order.orderName || '×œ×œ×').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const custDes = String(order.custDes || '×œ×œ×').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const custName = String(order.custName || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const mealName = String(order.mealName || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            html += '<div class="modal-item">';
            html += `<strong>×”×–×× ×”: ${orderName}</strong>`;
            html += `<span>×œ×§×•×—: ${custDes}</span>`;
            if (custName) {
                html += `<span>××¡×¤×¨ ×œ×§×•×—: ${custName}</span>`;
            }
            if (mealName) {
                html += `<span>××¨×•×—×”: ${mealName}</span>`;
            }
            if (order.quantity > 0) {
                html += `<span>×›××•×ª: ${order.quantity.toFixed(1)}</span>`;
            }
            html += '</div>';
        });

        html += `<div style="margin-top:15px;padding:10px;background:#e8f5e9;border-radius:5px;text-align:center;font-weight:bold;">×¡×”"×›: ${sortedOrders.length} ×”×–×× ×•×ª</div>`;
    } else {
        html = '<p style="text-align:center;padding:20px;color:#999;">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</p>';
    }

    modalBody.innerHTML = html;
    modal.classList.add('active');
}

// ×¡×’×™×¨×ª ×¤×•×¤××¤
function closeItemModal() {
    const modal = document.getElementById('itemModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

// ×¡×’×™×¨×ª modal ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×ª×•×›×Ÿ
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('itemModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeItemModal();
            }
        });
    }
});

// ×‘× ×™×™×ª ×˜×‘×œ×” ×œ×™×•× ××—×“ - ×¢× ×”×¤×¨×“×” ×œ×¡×§×¦×™×•×ª
function buildDayTable(dayProducts, date, dayIndex) {
    const { gastronorm, packs, containers, trays } = dayProducts;

    const hasGastronorm = Object.keys(gastronorm).length > 0;
    const hasPacks = Object.keys(packs).length > 0;
    const hasContainers = Object.keys(containers).length > 0;
    const hasTrays = Object.keys(trays).length > 0;

    if (!hasGastronorm && !hasPacks && !hasContainers && !hasTrays) {
        return {
            html: `
                <div class="day-table-container">
                    <div class="day-title">${formatDateHebrew(date)}</div>
                    <p style="text-align:center;padding:20px;color:#999;background:#fafafa;border:2px solid #333;border-top:none;">×œ× × ××¦××• × ×ª×•× ×™×</p>
                </div>
            `,
            totals: { gastronormContainers: 0, gastronormWeight: 0, containers: 0, containerWeight: 0, pack5: 0, pack7: 0, packWeight: 0, trays: 0 }
        };
    }

    let html = `<div class="day-table-container">`;
    html += `<div class="day-title">${formatDateHebrew(date)}</div>`;

    const totals = {
        gastronormContainers: 0,
        gastronormWeight: 0,
        containers: 0,
        containerWeight: 0,
        pack5: 0,
        pack7: 0,
        packWeight: 0,
        trays: 0
    };

    // ×˜×‘×œ×ª ×’×¡×˜×¨×•× ×•×
    if (hasGastronorm) {
        html += '<div class="section-title gastronorm">ğŸ± ×’×¡×˜×¨×•× ×•×</div>';
        html += '<table class="report-table">';
        html += '<thead><tr>';
        html += '<th class="product-col">××•×¦×¨</th>';
        html += '<th>××™×›×œ×™×</th>';
        html += '<th>××©×§×œ (×§"×’)</th>';
        html += '</tr></thead><tbody>';

        const sortedGastronorm = Object.values(gastronorm).sort((a, b) => a.name.localeCompare(b.name, 'he'));
        sortedGastronorm.forEach(product => {
            const escapedName = product.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
            html += '<tr>';
            html += `<td class="product-name" onclick="openItemModal('${escapedName}', ${dayIndex})" title="×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×”×–×× ×•×ª">${product.name}</td>`;
            html += `<td>${product.containers > 0 ? product.containers : '-'}</td>`;
            html += `<td>${product.weight > 0 ? product.weight.toFixed(1) : '-'}</td>`;
            html += '</tr>';
            totals.gastronormContainers += product.containers;
            totals.gastronormWeight += product.weight;
        });

        html += '<tr>';
        html += '<td class="total-row">×¡×”"×› ×’×¡×˜×¨×•× ×•×</td>';
        html += `<td class="total-row">${totals.gastronormContainers}</td>`;
        html += `<td class="total-row">${totals.gastronormWeight.toFixed(1)}</td>`;
        html += '</tr></tbody></table>';
    }

    // ×˜×‘×œ×ª ×××¨×–×™× (5 ×•-7)
    if (hasPacks) {
        html += '<div class="section-title">ğŸ“¦ ×××¨×–×™×</div>';
        html += '<table class="report-table">';
        html += '<thead><tr>';
        html += '<th class="product-col">××•×¦×¨</th>';
        html += '<th>×××¨×– 5</th>';
        html += '<th>×××¨×– 7</th>';
        html += '<th>××©×§×œ (×§"×’)</th>';
        html += '</tr></thead><tbody>';

        const sortedPacks = Object.values(packs).sort((a, b) => a.name.localeCompare(b.name, 'he'));
        sortedPacks.forEach(product => {
            const escapedName = product.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
            html += '<tr>';
            html += `<td class="product-name" onclick="openItemModal('${escapedName}', ${dayIndex})" title="×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×”×–×× ×•×ª">${product.name}</td>`;
            html += `<td>${product.pack5 > 0 ? product.pack5 : '-'}</td>`;
            html += `<td>${product.pack7 > 0 ? product.pack7 : '-'}</td>`;
            html += `<td>${product.packWeight > 0 ? product.packWeight.toFixed(1) : '-'}</td>`;
            html += '</tr>';
            totals.pack5 += product.pack5;
            totals.pack7 += product.pack7;
            totals.packWeight += product.packWeight;
        });

        html += '<tr>';
        html += '<td class="total-row">×¡×”"×› ×××¨×–×™×</td>';
        html += `<td class="total-row">${totals.pack5}</td>`;
        html += `<td class="total-row">${totals.pack7}</td>`;
        html += `<td class="total-row">${totals.packWeight.toFixed(1)}</td>`;
        html += '</tr></tbody></table>';
    }

    // ×˜×‘×œ×ª ××™×›×œ×™× ×¨×’×™×œ×™×
    if (hasContainers) {
        html += '<div class="section-title">ğŸ¥¡ ××™×›×œ×™×</div>';
        html += '<table class="report-table">';
        html += '<thead><tr>';
        html += '<th class="product-col">××•×¦×¨</th>';
        html += '<th>××™×›×œ×™×</th>';
        html += '<th>××©×§×œ (×§"×’)</th>';
        html += '</tr></thead><tbody>';

        const sortedContainers = Object.values(containers).sort((a, b) => a.name.localeCompare(b.name, 'he'));
        sortedContainers.forEach(product => {
            const escapedName = product.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
            html += '<tr>';
            html += `<td class="product-name" onclick="openItemModal('${escapedName}', ${dayIndex})" title="×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×”×–×× ×•×ª">${product.name}</td>`;
            html += `<td>${product.containers > 0 ? product.containers : '-'}</td>`;
            html += `<td>${product.weight > 0 ? product.weight.toFixed(1) : '-'}</td>`;
            html += '</tr>';
            totals.containers += product.containers;
            totals.containerWeight += product.weight;
        });

        html += '<tr>';
        html += '<td class="total-row">×¡×”"×› ××™×›×œ×™×</td>';
        html += `<td class="total-row">${totals.containers}</td>`;
        html += `<td class="total-row">${totals.containerWeight.toFixed(1)}</td>`;
        html += '</tr></tbody></table>';
    }

    // ×˜×‘×œ×ª ×—××’×©×™×•×ª
    if (hasTrays) {
        html += '<div class="section-title">ğŸ½ï¸ ×—××’×©×™×•×ª</div>';
        html += '<table class="report-table">';
        html += '<thead><tr>';
        html += '<th class="product-col">××•×¦×¨</th>';
        html += '<th>×›××•×ª ×× ×•×ª</th>';
        html += '</tr></thead><tbody>';

        const sortedTrays = Object.values(trays).sort((a, b) => a.name.localeCompare(b.name, 'he'));
        sortedTrays.forEach(product => {
            const escapedName = product.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
            html += '<tr>';
            html += `<td class="product-name" onclick="openItemModal('${escapedName}', ${dayIndex})" title="×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×”×–×× ×•×ª">${product.name}</td>`;
            html += `<td>${product.trays > 0 ? product.trays : '-'}</td>`;
            html += '</tr>';
            totals.trays += product.trays;
        });

        html += '<tr>';
        html += '<td class="total-row">×¡×”"×› ×—××’×©×™×•×ª</td>';
        html += `<td class="total-row">${totals.trays}</td>`;
        html += '</tr></tbody></table>';
    }

    html += '</div>';

    return { html, totals };
}

// ×¢×“×›×•×Ÿ ×›×¨×˜×™×¡×™ ×¡×™×›×•×
function updateSummaryCards(grandTotal) {
    const container = document.getElementById('summaryCards');
    container.style.display = 'grid';

    container.innerHTML = `
        <div class="summary-card gastronorm">
            <h3>×’×¡×˜×¨×•× ×•× - ××™×›×œ×™×</h3>
            <div class="value">${grandTotal.gastronormContainers}</div>
        </div>
        <div class="summary-card gastronorm">
            <h3>×’×¡×˜×¨×•× ×•× - ××©×§×œ</h3>
            <div class="value">${grandTotal.gastronormWeight.toFixed(1)}</div>
        </div>
        <div class="summary-card hot">
            <h3>××™×›×œ×™× ×¨×’×™×œ×™×</h3>
            <div class="value">${grandTotal.containers}</div>
        </div>
        <div class="summary-card">
            <h3>×××¨×– 5</h3>
            <div class="value">${grandTotal.pack5}</div>
        </div>
        <div class="summary-card">
            <h3>×××¨×– 7</h3>
            <div class="value">${grandTotal.pack7}</div>
        </div>
        <div class="summary-card hot">
            <h3>×—××’×©×™×•×ª</h3>
            <div class="value">${grandTotal.trays}</div>
        </div>
    `;
}

// ×˜×¢×™× ×ª ×”×“×•×—
async function loadReport() {
    const statusDiv = document.getElementById('status');
    const reportContainer = document.getElementById('reportContainer');
    const loadBtn = document.getElementById('loadBtn');
    const printBtn = document.getElementById('printBtn');
    const csvBtn = document.getElementById('csvBtn');
    const branchSelect = document.getElementById('branchSelect').value;

    loadBtn.disabled = true;
    printBtn.disabled = true;
    csvBtn.disabled = true;
    statusDiv.className = 'status loading';
    statusDiv.innerHTML = '×˜×•×¢×Ÿ × ×ª×•× ×™× ××”×©×¨×ª...';
    reportContainer.innerHTML = '';
    document.getElementById('summaryCards').style.display = 'none';

    // ××™×¤×•×¡ × ×ª×•× ×™ ×”×”×–×× ×•×ª
    productOrdersData = {};

    try {
        // ××©×™×›×ª × ×ª×•× ×™× ×œ×›×œ 4 ×”×™××™×
        allDaysDataGlobal = [];
        reportData = [];

        let allHTML = '';
        const grandTotal = {
            gastronormContainers: 0,
            gastronormWeight: 0,
            containers: 0,
            containerWeight: 0,
            pack5: 0,
            pack7: 0,
            packWeight: 0,
            trays: 0
        };

        for (let i = 0; i < workingDays.length; i++) {
            statusDiv.innerHTML = `×˜×•×¢×Ÿ × ×ª×•× ×™× ×œ×™×•× ${i + 1} ××ª×•×š 4...`;
            const dayData = await fetchDataForDate(workingDays[i], branchSelect);
            // ×¡×™× ×•×Ÿ ×¨×§ ×¤×¨×™×˜×™× ×—××™×
            const hotData = filterHotItems(dayData);
            allDaysDataGlobal.push(hotData);

            // ×¢×™×‘×•×“ ×”× ×ª×•× ×™× ×œ×™×•× ×–×” (×¢× ×©××™×¨×ª ×”×–×× ×•×ª)
            const dayProducts = processDataForDay(hotData, i, branchSelect);
            reportData.push(dayProducts);

            // ×‘× ×™×™×ª ×”×˜×‘×œ×” ×œ×™×•× ×–×”
            const result = buildDayTable(dayProducts, workingDays[i], i);
            allHTML += result.html;

            // ×¦×‘×™×¨×ª ×¡×™×›×•××™× ×›×œ×œ×™×™×
            grandTotal.gastronormContainers += result.totals.gastronormContainers;
            grandTotal.gastronormWeight += result.totals.gastronormWeight;
            grandTotal.containers += result.totals.containers;
            grandTotal.containerWeight += result.totals.containerWeight;
            grandTotal.pack5 += result.totals.pack5;
            grandTotal.pack7 += result.totals.pack7;
            grandTotal.packWeight += result.totals.packWeight;
            grandTotal.trays += result.totals.trays;
        }

        reportContainer.innerHTML = allHTML;

        // ×¢×“×›×•×Ÿ ×›×¨×˜×™×¡×™ ×¡×™×›×•×
        updateSummaryCards(grandTotal);

        const totalProducts = new Set();
        reportData.forEach(day => {
            Object.keys(day.gastronorm).forEach(p => totalProducts.add(p));
            Object.keys(day.packs).forEach(p => totalProducts.add(p));
            Object.keys(day.containers).forEach(p => totalProducts.add(p));
            Object.keys(day.trays).forEach(p => totalProducts.add(p));
        });

        statusDiv.className = 'status success';
        statusDiv.innerHTML = `× ×˜×¢× ×• ${totalProducts.size} ××•×¦×¨×™× ×—××™× ×œ-4 ×™××™×`;

        printBtn.disabled = false;
        csvBtn.disabled = false;

    } catch (error) {
        console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×“×•×—:', error);
        statusDiv.className = 'status error';
        statusDiv.innerHTML = `×©×’×™××”: ${error.message}`;
    } finally {
        loadBtn.disabled = false;
    }
}

// ×”×“×¤×¡×ª ×”×“×•×—
function printReport() {
    window.print();
}

// ×”×•×¨×“×ª CSV
function downloadCSV() {
    if (!reportData || reportData.length === 0) return;

    let csv = '\uFEFF'; // BOM for UTF-8

    // ×¢×‘×•×¨ ×›×œ ×™×•× - ×˜×‘×œ××•×ª × ×¤×¨×“×•×ª
    workingDays.forEach((date, dayIndex) => {
        const dayProducts = reportData[dayIndex];
        if (!dayProducts) return;

        csv += `\n${formatDateHebrew(date)}\n`;

        // ×’×¡×˜×¨×•× ×•×
        if (Object.keys(dayProducts.gastronorm).length > 0) {
            csv += '\n×’×¡×˜×¨×•× ×•×\n';
            csv += '××•×¦×¨,××™×›×œ×™×,××©×§×œ\n';
            Object.values(dayProducts.gastronorm).sort((a, b) => a.name.localeCompare(b.name, 'he')).forEach(product => {
                csv += `"${product.name}",${product.containers},${product.weight.toFixed(1)}\n`;
            });
        }

        // ×××¨×–×™×
        if (Object.keys(dayProducts.packs).length > 0) {
            csv += '\n×××¨×–×™×\n';
            csv += '××•×¦×¨,×××¨×– 5,×××¨×– 7,××©×§×œ\n';
            Object.values(dayProducts.packs).sort((a, b) => a.name.localeCompare(b.name, 'he')).forEach(product => {
                csv += `"${product.name}",${product.pack5},${product.pack7},${product.packWeight.toFixed(1)}\n`;
            });
        }

        // ××™×›×œ×™×
        if (Object.keys(dayProducts.containers).length > 0) {
            csv += '\n××™×›×œ×™×\n';
            csv += '××•×¦×¨,××™×›×œ×™×,××©×§×œ\n';
            Object.values(dayProducts.containers).sort((a, b) => a.name.localeCompare(b.name, 'he')).forEach(product => {
                csv += `"${product.name}",${product.containers},${product.weight.toFixed(1)}\n`;
            });
        }

        // ×—××’×©×™×•×ª
        if (Object.keys(dayProducts.trays).length > 0) {
            csv += '\n×—××’×©×™×•×ª\n';
            csv += '××•×¦×¨,×›××•×ª\n';
            Object.values(dayProducts.trays).sort((a, b) => a.name.localeCompare(b.name, 'he')).forEach(product => {
                csv += `"${product.name}",${product.trays}\n`;
            });
        }

        csv += '\n';
    });

    // ×”×•×¨×“×”
    const branchSelect = document.getElementById('branchSelect').value;
    const branchName = branchSelect === 'south' ? '×“×¨×•×' : branchSelect === 'north' ? '×¦×¤×•×Ÿ' : '×”×›×œ';
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `×“×•×—_×™×™×¦×•×¨_×—×_${branchName}_${formatDateForAPI(new Date())}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ××ª×—×•×œ ×‘×˜×¢×™× ×ª ×”×“×£
document.addEventListener('DOMContentLoaded', function() {
    updateDateRangeDisplay();
});
</script>

</body>
</html>
