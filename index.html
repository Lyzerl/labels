<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>נתוני Priority - לפי סניף</title>
<!-- PWA Meta Tags -->
<meta name="theme-color" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ביק הזמנות">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">
<!-- Preconnect לטעינה מהירה יותר של CDN -->
<link rel="preconnect" href="https://code.jquery.com" crossorigin>
<link rel="preconnect" href="https://cdn.datatables.net" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<!-- ניווט משותף - נטען מוקדם -->
<script src="js/nav.js" defer></script>
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<!-- קובץ CSS מקומי -->
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="container">
  <!-- תפריט ניווט משותף - הסקריפט נטען ב-head עם defer -->
  <nav id="main-nav"></nav>

  <h1>📊 נתוני Priority - לפי תאריך וסניף</h1>

  <div class="top-actions">
    <button class="btn settings-btn" onclick="openCartonSettingsModal()">⚙️ הגדרות קרטונים</button>
  </div>

  <div class="controls">
    <div class="control-group">
      <label for="dateInput">תאריך:</label>
      <input type="date" id="dateInput">
    </div>
    
    <div class="control-group">
      <label for="branchSelect">סניף:</label>
      <select id="branchSelect">
        <option value="all">הכל</option>
        <option value="south">דרום </option>
        <option value="north">צפון </option>
      </select>
    </div>
    
    <button class="btn" onclick="fetchData()" id="fetchBtn">🔄 משוך נתונים</button>
    <button class="btn download" onclick="downloadCSV()" id="downloadBtn" disabled>📥 הורד CSV</button>
  </div>

  <div id="status"></div>

  <div class="stats">
    <div class="stat-item">
      <div class="stat-label">רשומות</div>
      <div class="stat-value" id="recordCount">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">דפים</div>
      <div class="stat-value" id="pageCount">0</div>
    </div>
  </div>

  <!-- טאבים לדוחות -->
  <div class="tabs" id="tabsContainer" style="display: none;">
    <button class="tab-btn active" onclick="showTab('general', this)">📋 טבלה כללית</button>
    <button class="tab-btn" onclick="showTab('summary', this)">❄️ דוח אריזה קרה</button>
    <button class="tab-btn" onclick="showTab('trays', this)">🔥 דוח אריזה חמה</button>
    <button class="tab-btn" onclick="showTab('allergens', this)">🚫 דוח אלרגנים</button>
    <button class="tab-btn" onclick="showTab('labelsHot', this)">🏷️🔥 מדבקות חמים</button>
    <button class="tab-btn" onclick="showTab('labelsCold', this)">🏷️❄️ מדבקות קרים</button>
    <button class="tab-btn" onclick="showTab('allergenLabels', this)">🥜 מדבקות אלרגנים</button>
    <button class="tab-btn" onclick="showTab('driver', this)">🚚 דוח נהג</button>
  </div>

  <!-- תוכן טאבים -->
  <div id="tabGeneral" class="tab-content active">
  <div class="table-container" id="tableContainer"></div>
  </div>

  <div id="tabSummary" class="tab-content">
    <div class="report-controls">
      <label>סניף:</label>
      <select id="summaryBranchFilter">
        <option value="">הכל</option>
      </select>
      <label>לפי קטגוריה:</label>
      <select id="summaryPSPEC6Filter">
        <option value="all">הכל</option>
        <option value="notempty">רק לא ריק</option>
      </select>
      <button class="btn download" onclick="downloadSummaryCSV()" id="downloadSummaryBtn">📥 הורד CSV</button>
    </div>
    <div class="table-container" id="summaryContainer"></div>
  </div>

  <div id="tabTrays" class="tab-content">
    <div class="report-controls">
      <label>סניף:</label>
      <select id="traysBranchFilter">
        <option value="">הכל</option>
      </select>
      <label>קו חלוקה:</label>
      <select id="traysDistrLineFilter">
        <option value="">הכל</option>
      </select>
      <button class="btn download" onclick="downloadTraysPDF()" id="downloadTraysPDFBtn">📄 הורד PDF</button>
      <button class="btn" onclick="toggleTabularView()" id="toggleTabularViewBtn" style="background:#4CAF50;color:white;">📊 תצוגה טבלאית</button>
      <button class="btn" onclick="showProductionReport()" id="productionReportBtn" style="background:#FF9800;color:white;">🏭 דוח ייצור</button>
    </div>
    <div class="table-container" id="traysContainer"></div>
    <div id="tabularViewContainer" style="display:none;"></div>
  </div>

  <div id="tabAllergens" class="tab-content">
    <div class="report-controls">
      <button class="btn download" onclick="printAllergensReport()">🖨️ הדפס / PDF</button>
    </div>
    <div class="table-container" id="allergensContainer"></div>
  </div>

  <div id="tabContainers" class="tab-content">
    <div class="report-controls">
      <label>סניף:</label>
      <select id="containersBranchFilter">
        <option value="">הכל</option>
      </select>
      <button class="btn" onclick="applyContainersFilters()">🔍 החל סינון</button>
      <button class="btn download" onclick="downloadContainersCSV()" id="downloadContainersBtn">📥 הורד CSV</button>
    </div>
    <div class="table-container" id="containersContainer"></div>
  </div>

  <div id="tabLabelsHot" class="tab-content">
    <div class="report-controls">
      <label>קו חלוקה:</label>
      <select id="distrLineFilterHot">
        <option value="">הכל</option>
      </select>
      <label>שיטת אריזה:</label>
      <select id="packingMethodFilterHot">
        <option value="">הכל</option>
        <option value="tray">חמגשיות</option>
        <option value="gastronorm">גסטרונום בלבד</option>
        <option value="loose">תפזורת</option>
      </select>
      <label>סוג לקוח:</label>
      <select id="customerTypeFilterHot">
        <option value="">הכל</option>
        <option value="milgam">מילגם</option>
        <option value="notMilgam">לא מילגם</option>
      </select>
      <label>כשרות:</label>
      <select id="kashrutFilterHot">
        <option value="">הכל</option>
      </select>
      <label>סדר מיון:</label>
      <select id="labelsSortModeFilterHot">
        <option value="distribution">קו חלוקה + סדר הפצה</option>
        <option value="loading">לפי סדר העמסה</option>
      </select>
      <label>חיפוש:</label>
      <input type="text" id="labelsSearchInputHot" placeholder="חפש לפי שם מוסד או מס׳ לקוח..." style="padding:5px;font-size:14px;width:250px;border:1px solid #ccc;border-radius:4px;">
    </div>
    <div class="labels-actions">
      <button class="btn download" onclick="downloadLabelsCSV('hot')" id="downloadLabelsBtnHot">📥 הורד CSV</button>
      <button class="btn download" onclick="downloadLabelsPDF('hot')" id="downloadLabelsPDFBtnHot">📄 הורד PDF</button>
      <button class="btn" onclick="openHighlightDishesModal()" id="highlightDishesBtnHot" style="background:#FF9800;color:white;">🎨 מנות להדגשה</button>
    </div>
    <div class="table-container" id="labelsContainerHot"></div>
  </div>

  <div id="tabLabelsCold" class="tab-content">
    <div class="report-controls">
      <label>קו חלוקה:</label>
      <select id="distrLineFilterCold">
        <option value="">הכל</option>
      </select>
      <label>שיטת אריזה ראשית:</label>
      <select id="packingMethodFilterCold">
        <option value="">הכל</option>
      </select>
      <label>סוג מוסד:</label>
      <select id="institutionTypeFilterCold">
        <option value="">הכל</option>
        <option value="gan">גן</option>
        <option value="school">בית ספר</option>
      </select>
      <label>סוג לקוח:</label>
      <select id="customerTypeFilterCold">
        <option value="">הכל</option>
        <option value="milgam">מילגם</option>
        <option value="private">פרטי</option>
      </select>
      <label>סדר מיון:</label>
      <select id="labelsSortModeFilterCold">
        <option value="distribution">קו חלוקה + סדר הפצה</option>
      </select>
      <label>חיפוש:</label>
      <input type="text" id="labelsSearchInputCold" placeholder="חפש לפי שם מוסד או מס׳ לקוח..." style="padding:5px;font-size:14px;width:250px;border:1px solid #ccc;border-radius:4px;">
    </div>
    <div class="labels-actions">
      <button class="btn download" onclick="downloadLabelsCSV('cold')" id="downloadLabelsBtnCold">📥 הורד CSV</button>
      <button class="btn download" onclick="downloadLabelsPDF('cold')" id="downloadLabelsPDFBtnCold">📄 הורד PDF</button>
    </div>
    <div class="table-container" id="labelsContainerCold"></div>
  </div>

  <div id="tabAllergenLabels" class="tab-content">
    <div class="report-controls">
      <label>סוג מדבקות:</label>
      <select id="allergenLabelsTypeFilter">
        <option value="allergen">אלרגני</option>
        <option value="vegetarian">צמחוני</option>
        <option value="soup">מרק</option>
      </select>
      <label>קו חלוקה:</label>
      <select id="allergenLabelsDistrLineFilter">
        <option value="">הכל</option>
      </select>
      <label>סדר מיון:</label>
      <select id="allergenLabelsSortFilter">
        <option value="distribution">קו חלוקה + סדר הפצה</option>
        <option value="customer">לפי שם לקוח</option>
      </select>
    </div>
    <div class="labels-actions">
      <button class="btn download" onclick="printAllergenLabels()" id="printAllergenLabelsBtn">🖨️ הדפס מדבקות</button>
      <button class="btn download" onclick="downloadAllergenLabelsPDF()" id="downloadAllergenLabelsPDFBtn">📄 הורד PDF</button>
    </div>
    <div class="table-container" id="allergenLabelsContainer"></div>
  </div>

  <div id="tabDriver" class="tab-content">
    <div class="report-controls">
      <label>קו חלוקה:</label>
      <select id="driverDistrLineFilter">
        <option value="">הכל</option>
      </select>
    </div>
    <div class="labels-actions">
      <button class="btn download" onclick="printDriverReport()">🖨️ הדפס דוח</button>
      <button class="btn download" onclick="downloadDriverPDF()">📄 הורד PDF</button>
    </div>
    <div class="table-container" id="driverReportContainer"></div>
  </div>
</div>

<!-- Modal for showing order details -->
<div id="itemModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">פרטי הזמנות</h2>
      <button class="modal-close" onclick="closeItemModal()">✕ סגור</button>
    </div>
    <div class="modal-body" id="modalBody">
      <!-- Content will be inserted here -->
    </div>
  </div>
</div>

<!-- Modal for highlight dishes -->
<div id="highlightDishesModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:700px;">
    <div class="modal-header">
      <h2>🎨 מנות להדגשה</h2>
      <button class="modal-close" onclick="closeHighlightDishesModal()">✕ סגור</button>
    </div>
    <div class="modal-body" style="text-align:right;max-height:70vh;overflow-y:auto;">
      <p style="margin-bottom:15px;color:#666;">בחר מנות להדגשה בצבע. המנות המסומנות יודגשו במדבקות.</p>
      <div id="highlightDishesList" style="display:flex;flex-direction:column;gap:10px;">
        <!-- רשימת המנות תיווצר דינמית -->
      </div>
      <div class="settings-actions" style="margin-top:20px;">
        <button class="btn" onclick="applyHighlightDishes()" style="background:#4CAF50;color:white;">✓ החל הדגשות</button>
        <button class="btn" onclick="clearHighlightDishes()" style="background:#f44336;color:white;">✕ נקה הכל</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for carton settings -->
<div id="cartonSettingsModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <h2>⚙️ הגדרות קרטונים</h2>
      <button class="modal-close" onclick="closeCartonSettingsModal()">✕ סגור</button>
    </div>
    <div class="modal-body" style="text-align:right;">
      <div class="settings-section">
        <h3>🔥 חם - חמגשית</h3>
        <div class="setting-row">
          <label>חמגשיות גדולות לקרטון:</label>
          <input type="number" id="settingLargeTrayPerCarton" min="1" max="100" value="28">
        </div>
        <div class="setting-row">
          <label>חמגשיות קטנות לקרטון:</label>
          <input type="number" id="settingSmallTrayPerCarton" min="1" max="100" value="32">
        </div>
      </div>

      <div class="settings-section">
        <h3>🔥 חם - תפזורת</h3>
        <div class="setting-row">
          <label>קיבולת קרטון (יחידות בסיס):</label>
          <input type="number" id="settingCartonCapacity" min="1" max="50" step="0.5" value="10">
        </div>
        <h4 style="margin:15px 0 10px;color:#666;font-size:0.95em;">גודל יחסי לכל סוג מיכל:</h4>
        <div class="setting-row">
          <label>מיכל רגיל:</label>
          <input type="number" id="settingContainerSize" min="0.1" max="10" step="0.1" value="1">
        </div>
        <div class="setting-row">
          <label>גסטרונום:</label>
          <input type="number" id="settingGastronormSize" min="0.1" max="10" step="0.1" value="4">
        </div>
        <div class="setting-row">
          <label>מארז 5:</label>
          <input type="number" id="settingPack5Size" min="0.1" max="10" step="0.1" value="0.5">
        </div>
        <div class="setting-row">
          <label>מארז 7:</label>
          <input type="number" id="settingPack7Size" min="0.1" max="10" step="0.1" value="0.7">
        </div>
      </div>

      <div class="settings-section">
        <h3>❄️ קר</h3>
        <div class="setting-row">
          <label>סף פריטים (מעל = הרבה פריטים):</label>
          <input type="number" id="settingFewItemsThreshold" min="1" max="20" value="5">
        </div>
        <div class="setting-row">
          <label>מנות לקרטון (מעט פריטים):</label>
          <input type="number" id="settingPortionsFewItems" min="1" max="100" value="20">
        </div>
        <div class="setting-row">
          <label>מנות לקרטון (הרבה פריטים):</label>
          <input type="number" id="settingPortionsManyItems" min="1" max="100" value="15">
        </div>
      </div>

      <div class="settings-actions">
        <button class="btn" onclick="saveCartonSettings()" style="background:#4CAF50;color:white;">💾 שמור הגדרות</button>
        <button class="btn" onclick="resetCartonSettings()" style="background:#f44336;color:white;">↩️ אפס לברירת מחדל</button>
      </div>
    </div>
  </div>
</div>


<!-- jQuery and DataTables - defer לטעינה מהירה יותר -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js" defer></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js" defer></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js" defer></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

<!-- קבצי JavaScript של האפליקציה - defer שומר על סדר הטעינה -->
<script src="js/config.js" defer></script>
<script src="js/app.js" defer></script>

<!-- רישום Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('Service Worker registered'))
      .catch(err => console.log('Service Worker registration failed:', err));
  });
}
</script>

</body>
</html>
