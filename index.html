<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>× ×ª×•× ×™ Priority - ×œ×¤×™ ×¡× ×™×£</title>
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<style>
body { 
  font-family: Arial, sans-serif; 
  padding: 20px; 
  direction: rtl; 
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
}
.container {
  max-width: 1400px;
  margin: 0 auto;
  background: white;
  border-radius: 15px;
  padding: 30px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
h1 { 
  color: #4285f4; 
  text-align: center;
  margin-bottom: 30px;
}
.controls { 
  background: #f8f9fa; 
  padding: 20px; 
  border-radius: 10px; 
  margin-bottom: 20px;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}
.control-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.control-group label {
  font-weight: bold;
  font-size: 0.9em;
  color: #333;
}
input[type="date"], select {
  padding: 10px 15px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 1em;
}
.btn { 
  padding: 10px 25px; 
  background: #4285f4; 
  color: white; 
  border: none; 
  border-radius: 8px;
  cursor: pointer; 
  font-size: 1em;
  font-weight: bold;
  transition: all 0.3s;
}
.btn:hover:not(:disabled) { 
  background: #3367d6;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
}
.btn:disabled { 
  background: #ccc; 
  cursor: not-allowed;
  transform: none;
}
.btn.download { 
  background: #34a853; 
}
.btn.download:hover:not(:disabled) { 
  background: #2d8e47; 
}
.status { 
  padding: 15px; 
  margin: 15px 0; 
  border-radius: 8px;
  text-align: center;
  font-weight: bold;
}
.status.loading { 
  background: #fff3e0; 
  color: #ff9800; 
}
.status.success { 
  background: #e8f5e9; 
  color: #4caf50; 
}
.status.error { 
  background: #ffebee; 
  color: #f44336; 
}
.stats {
  display: flex;
  gap: 30px;
  justify-content: center;
  margin: 15px 0;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}
.stat-item {
  text-align: center;
}
.stat-label {
  font-size: 0.85em;
  color: #666;
}
.stat-value {
  font-size: 1.8em;
  font-weight: bold;
  color: #4285f4;
}
table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 20px;
  font-size: 0.9em;
}
th, td { 
  border: 1px solid #ddd; 
  padding: 12px; 
  text-align: right; 
}
th { 
  background: #4285f4; 
  color: white;
  position: sticky;
  top: 0;
  z-index: 10;
  position: relative;
}
th {
  padding: 8px !important;
}
th .header-text {
  font-weight: bold;
  margin-bottom: 5px;
  color: white;
}
th input.column-filter {
  width: 100%;
  padding: 5px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.85em;
  box-sizing: border-box;
  direction: rtl;
  background: white;
  color: #333;
}
th input.column-filter:focus {
  outline: 2px solid #fff;
  border-color: #fff;
  box-shadow: 0 0 5px rgba(255,255,255,0.5);
}
tr:hover { 
  background: #f5f5f5; 
}
tr:nth-child(even) {
  background: #fafafa;
}
.table-container {
  max-height: 600px;
  overflow-y: auto;
  margin-top: 20px;
}
.loader {
  border: 5px solid #f3f3f3;
  border-top: 5px solid #4285f4;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ×¢×™×¦×•×‘ ×˜××‘×™× */
.tabs {
  display: flex;
  gap: 10px;
  margin: 20px 0;
  border-bottom: 2px solid #ddd;
  flex-wrap: wrap;
}
.tab-btn {
  padding: 12px 24px;
  background: #f0f0f0;
  border: none;
  border-radius: 8px 8px 0 0;
  cursor: pointer;
  font-size: 1em;
  font-weight: bold;
  color: #666;
  transition: all 0.3s;
  position: relative;
  top: 2px;
}
.tab-btn:hover {
  background: #e0e0e0;
  color: #333;
}
.tab-btn.active {
  background: white;
  color: #4285f4;
  border: 2px solid #ddd;
  border-bottom: 2px solid white;
}
.tab-content {
  display: none;
  padding: 20px 0;
}
.tab-content.active {
  display: block;
}
.report-controls {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.label-card {
  width: 48%;
  display: inline-block;
  vertical-align: top;
  box-sizing: border-box;
  margin: 8px 1%;
  page-break-inside: avoid;
}
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ“Š × ×ª×•× ×™ Priority - ×œ×¤×™ ×ª××¨×™×š ×•×¡× ×™×£</h1>

  <div class="controls">
    <div class="control-group">
      <label for="dateInput">×ª××¨×™×š:</label>
      <input type="date" id="dateInput">
    </div>
    
    <div class="control-group">
      <label for="branchSelect">×¡× ×™×£:</label>
      <select id="branchSelect">
        <option value="all">×”×›×œ</option>
        <option value="south">×“×¨×•× (1 ×•××˜×”)</option>
        <option value="north">×¦×¤×•×Ÿ (3 ×•××¢×œ×”)</option>
      </select>
    </div>
    
    <button class="btn" onclick="fetchData()" id="fetchBtn">ğŸ”„ ××©×•×š × ×ª×•× ×™×</button>
    <button class="btn download" onclick="downloadCSV()" id="downloadBtn" disabled>ğŸ“¥ ×”×•×¨×“ CSV</button>
  </div>

  <div id="status"></div>

  <div class="stats">
    <div class="stat-item">
      <div class="stat-label">×¨×©×•××•×ª</div>
      <div class="stat-value" id="recordCount">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">×“×¤×™×</div>
      <div class="stat-value" id="pageCount">0</div>
    </div>
  </div>

  <!-- ×˜××‘×™× ×œ×“×•×—×•×ª -->
  <div class="tabs" id="tabsContainer" style="display: none;">
    <button class="tab-btn active" onclick="showTab('general', this)">ğŸ“‹ ×˜×‘×œ×” ×›×œ×œ×™×ª</button>
    <button class="tab-btn" onclick="showTab('summary', this)">ğŸ“Š ×¡×™×›×•× ×œ×¤×™ ×¤×¨×™×˜</button>
    <button class="tab-btn" onclick="showTab('labels', this)">ğŸ·ï¸ ×“×•×— ××“×‘×§×•×ª</button>
  </div>

  <!-- ×ª×•×›×Ÿ ×˜××‘×™× -->
  <div id="tabGeneral" class="tab-content active">
  <div class="table-container" id="tableContainer"></div>
  </div>

  <div id="tabSummary" class="tab-content">
    <div class="report-controls">
      <label>×¡× ×™×£:</label>
      <select id="summaryBranchFilter">
        <option value="">×”×›×œ</option>
      </select>
      <label>×©×™×˜×ª ××™×¨×•×–:</label>
      <select id="summaryPackingMethodFilter">
        <option value="">×”×›×œ</option>
        <option value="tray">×—××’×©×™×ª</option>
        <option value="bulk">×ª×¤×–×•×¨×ª</option>
      </select>
      <label>×¤×¨××˜×¨ 1 ×œ××•×¦×¨:</label>
      <select id="summaryPSPEC6Filter">
        <option value="all">×”×›×œ</option>
        <option value="notempty">×¨×§ ×œ× ×¨×™×§</option>
      </select>
      <label>×¡×•×’ ×§×¨×˜×•×Ÿ:</label>
      <select id="summaryCartonFilter">
        <option value="">×”×›×œ (×¢× ×¡×•×’ ×§×¨×˜×•×Ÿ)</option>
      </select>
      <button class="btn" onclick="applySummaryFilters()">ğŸ” ×”×—×œ ×¡×™× ×•×Ÿ</button>
      <button class="btn download" onclick="downloadSummaryCSV()" id="downloadSummaryBtn">ğŸ“¥ ×”×•×¨×“ CSV</button>
    </div>
    <div class="table-container" id="summaryContainer"></div>
  </div>

  <div id="tabLabels" class="tab-content">
    <div class="report-controls">
      <label>×§×• ×—×œ×•×§×”:</label>
      <select id="distrLineFilter">
        <option value="">×”×›×œ</option>
      </select>
      <label>×¡×•×’ ××“×‘×§×”:</label>
      <select id="labelsTempFilter">
        <option value="all">×”×›×œ</option>
        <option value="cold">×§×¨×™×</option>
        <option value="hot">×—××™×</option>
      </select>
      <label>×©×™×˜×ª ××¨×™×–×” ×¨××©×™×ª:</label>
      <select id="packingMethodFilter">
        <option value="">×”×›×œ</option>
      </select>
      <button class="btn download" onclick="downloadLabelsCSV()" id="downloadLabelsBtn">ğŸ“¥ ×”×•×¨×“ CSV</button>
    </div>
    <div class="table-container" id="labelsContainer"></div>
  </div>
</div>

<script>
// ***** ×©×™× ×›××Ÿ ××ª ×”-URL ×©×œ ×”-Cloudflare Worker ×©×œ×š! *****
const PROXY_URL = 'https://priority-proxy.lyzer-64d.workers.dev';

// ×¨×©×™××ª ×”×©×“×•×ª ×”××“×•×™×§×ª ×©×‘×™×§×©×ª
const SELECTED_FIELDS = [
  'ORDNAME',
  'DUEDATE',
  'BRANCHNAME',
  'CUSTNAME',
  'SPEC1',
  'CUSTDES',
  'CODEDES',
  'PRIT_CLASSNAME',
  'ADDRESS',
  'PHONENUM',
  'DISTRLINECODE',
  'DISTRLINEDES',
  'PRIT_DISTRORDER',
  'STATE',
  'SPEC2',
  'PARTNAME',
  'PARTDES',
  'PSPEC1',
  'PSPEC6',
  'PSPEC3',
  'PSPEC2',
  'PACKMETHODCODE',
  'EATQUANT',
  'TQUANT',
  'TUNITNAME',
  'PRIT_GENQUANT',
  'Y_9964_5_ESH',
  'Y_9965_5_ESH',
  'Y_37210_5_ESH',
  'CONTAINERS',
  'PACK5',
  'PACK7'
];

// ××™×¤×•×™ ×©×“×•×ª ×œ×¢×‘×¨×™×ª
const FIELD_NAMES_HEBREW = {
  'ORDNAME': '×”×–×× ×”',
  'DUEDATE': '×ª××¨×™×š ××¡×¤×§×”',
  'BRANCHNAME': '×¡× ×™×£',
  'CUSTNAME': '××¡ ×œ×§×•×—',
  'SPEC1': '×¡×•×’ ×œ×§×•×—',
  'CUSTDES': '×©× ×œ×§×•×—',
  'CODEDES': '×ª×™××•×¨ ××ª×¨',
  'PRIT_CLASSNAME': '×¡×•×’ ×œ×§×•×—',
  'ADDRESS': '×›×ª×•×‘×ª',
  'PHONENUM': '×˜×œ×¤×•×Ÿ',
  'DISTRLINECODE': '×§×• ×—×œ×•×§×”',
  'DISTRLINEDES': '×ª×™××•×¨ ×§×• ×—×œ×•×§×”',
  'PRIT_DISTRORDER': '×¡×“×¨ ×”×¤×¦×”',
  'STATE': '×¢×™×¨',
  'SPEC2': '×›×©×¨×•×ª',
  'PARTNAME': '××§×˜',
  'PARTDES': '×ª×™××•×¨ ××•×¦×¨',
  'PSPEC1': '×¤×¨××˜×¨ 1 ×œ××•×¦×¨',
  'PSPEC6': '×¤×¨××˜×¨ 6 ×œ××•×¦×¨',
  'PSPEC3': '×¤×¨××˜×¨ 3 ×œ××•×¦×¨',
  'PSPEC2': '×›×©×¨×•×ª',
  'PACKMETHODCODE': '×©×™×˜×ª ××¨×™×–×”',
  'EATQUANT': '××¡×¤×¨ ×× ×•×ª',
  'TQUANT': '×›××•×ª',
  'TUNITNAME': '×™×—×™×“×”',
  'PRIT_GENQUANT': '×›××•×ª ××¢×•×’×œ',
  'Y_9964_5_ESH': '×¤×¨××˜×¨ 7 ×œ××•×¦×¨',
  'Y_9965_5_ESH': '×¤×¨××˜×¨ 8 ×œ××•×¦×¨',
  'Y_37210_5_ESH': '×¡×•×’ ×§×¨×˜×•×Ÿ',
  'CONTAINERS': '××™×›×œ×™×',
  'PACK5': '×××¨×– 5',
  'PACK7': '×××¨×– 7'
};

let currentData = []; // × ×ª×•× ×™× ×’×•×œ××™×™× (×©×•×¨×•×ª)
let currentStructuredData = {}; // × ×ª×•× ×™× ××•×‘× ×™× (NoSQL - ×œ×¤×™ ×”×–×× ×”)

// ×¤×•× ×§×¦×™×” ×œ×”××¨×ª × ×ª×•× ×™× ×œ××‘× ×” NoSQL
function organizeAsNoSQL(rawData) {
  const orders = {};
  
  rawData.forEach(row => {
    const orderKey = row.ORDNAME || '×œ×œ×_×”×–×× ×”';
    
    // ×× ×–×• ×”×¤×¢× ×”×¨××©×•× ×” ×©××•×¤×™×¢×” ×”×”×–×× ×”, ×¦×•×¨ ××•×‘×™×™×§×˜ ×—×“×©
    if (!orders[orderKey]) {
      orders[orderKey] = {
        // ×©×“×•×ª ×©×œ ×”×”×–×× ×” - ××•×¤×™×¢×™× ×¨×§ ×¤×¢× ××—×ª
        orderName: row.ORDNAME || '',
        dueDate: row.DUEDATE || '',
        branchName: row.BRANCHNAME || '',
        custName: row.CUSTNAME || '',
        spec1: row.SPEC1 || '',
        custDes: row.CUSTDES || '',
        codeDes: row.CODEDES || '',
        pritClassname: row.PRIT_CLASSNAME || '',
        address: row.ADDRESS || '',
        phoneNum: row.PHONENUM || '',
        distrLineCode: row.DISTRLINECODE || '',
        distrLineDes: row.DISTRLINEDES || '',
        pritDistrOrder: row.PRIT_DISTRORDER || 0,
        state: row.STATE || '',
        spec2: row.SPEC2 || '',
        
        // ×›××•×ª ×× ×•×ª - × ×œ×§×—×ª ×¨×§ ×¤×¢× ××—×ª ×œ×›×œ ×”×–×× ×”
        eatQuant: parseFloat(row.EATQUANT) || 0,
        eatQuantNoAllergen: 0, // ×›××•×ª ×× ×•×ª ×œ×œ× ××œ×¨×’× ×™
        
        // ×¤×¨×™×˜×™× - ××¢×¨×š ×©×œ ××•×‘×™×™×§×˜×™×
        items: []
      };
    }
    
    // ×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ××¢×¨×š ×”×¤×¨×™×˜×™×
    const item = {
      partName: row.PARTNAME || '',
      partDes: row.PARTDES || '',
      pspec1: row.PSPEC1 || '',
      pspec6: row.PSPEC6 || '',
      pspec3: row.PSPEC3 || '',
      pspec2: row.PSPEC2 || '',
      packMethodCode: row.PACKMETHODCODE || '',
      eatQuant: parseFloat(row.EATQUANT) || 0,
      tQuant: parseFloat(row.TQUANT) || 0,
      tUnitName: row.TUNITNAME || '',
      pritGenQuant: parseFloat(row.PRIT_GENQUANT) || 0,
      y9964: row.Y_9964_5_ESH || '',
      y9965: row.Y_9965_5_ESH || '',
      cartonType: row.Y_37210_5_ESH || '',
      containers: row.CONTAINERS || '',
      pack5: row.PACK5 || '',
      pack7: row.PACK7 || ''
    };
    
    orders[orderKey].items.push(item);
    
    // ×‘×“×™×§×” ×× ×–×” ×œ×œ× ××œ×¨×’× ×™ ×•×¡×™×›×•× ×›××•×ª ×× ×•×ª
    const isNoAllergen = (row.SPEC2 && row.SPEC2.toString().toLowerCase().includes('×œ×œ× ××œ×¨×’× ×™')) ||
                         (row.PSPEC2 && row.PSPEC2.toString().toLowerCase().includes('×œ×œ× ××œ×¨×’× ×™')) ||
                         (row.SPEC2 && row.SPEC2.toString().toLowerCase().includes('×œ× ××œ×¨×’× ×™')) ||
                         (row.PSPEC2 && row.PSPEC2.toString().toLowerCase().includes('×œ× ××œ×¨×’× ×™'));
    
    if (isNoAllergen && item.eatQuant > 0) {
      orders[orderKey].eatQuantNoAllergen = Math.max(
        orders[orderKey].eatQuantNoAllergen || 0, 
        item.eatQuant
      );
    }
  });
  
  return orders;
}

// ×ª××¨×™×š ×‘×¨×™×¨×ª ××—×“×œ ×œ×”×™×•×
document.getElementById('dateInput').valueAsDate = new Date();

// ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ××™×›×œ×™× ×•×××¨×–×™×
function calculateContainersAndPacks(data) {
  return data.map(row => {
    // ×©×™××•×© ×‘-TQUANT (×›××•×ª) ×‘××§×•× PRIT_GENQUANT (×›××•×ª ××¢×•×’×œ)
    const tQuant = parseFloat(row.TQUANT) || 0;
    const param7 = parseFloat(row.Y_9964_5_ESH);
    const param8 = parseFloat(row.Y_9965_5_ESH);
    
    // ×—×™×©×•×‘ ××™×›×œ×™× - ×× ×™×© ×¤×¨××˜×¨ 7
    if (!isNaN(param7) && param7 > 0) {
      row.CONTAINERS = Math.round(tQuant / param7);
    } else {
      row.CONTAINERS = '';
    }
    
    // ×—×™×©×•×‘ ×××¨×– 5 ×•-7 - ×× ×™×© ×¤×¨××˜×¨ 8
    if (!isNaN(param8) && param8 > 0) {
      const totalServings = tQuant / param8;
      const optimized = optimizeServings(totalServings);
      row.PACK5 = optimized.five;
      row.PACK7 = optimized.seven;
    } else {
      row.PACK5 = '';
      row.PACK7 = '';
    }
    
    return row;
  });
}

async function fetchData() {
  const dateInput = document.getElementById('dateInput').value;
  const branchSelect = document.getElementById('branchSelect').value;
  const statusDiv = document.getElementById('status');
  const tableContainer = document.getElementById('tableContainer');
  const fetchBtn = document.getElementById('fetchBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const recordCount = document.getElementById('recordCount');
  const pageCountEl = document.getElementById('pageCount');
  
  if (!dateInput) {
    alert('×× × ×‘×—×¨ ×ª××¨×™×š');
    return;
  }
  
  // ×‘× ×™×™×ª ×”×¤×™×œ×˜×¨ - × ×¡×” ×¤×•×¨××˜ ×ª××¨×™×š ×©×•× ×”
  const dateStr = dateInput + 'T00:00:00Z';
  // × ×¡×” ×‘×œ×™ ××¨×›××•×ª - ××•×œ×™ ×”×©×¨×ª ×œ× ×¦×¨×™×š ××•×ª×
  let filter = `$filter=DUEDATE eq ${dateStr}`;
  
  // ×”×•×¡×¤×ª ×¤×™×œ×˜×¨ ×¡× ×™×£ - BRANCHNAME ×”×•× string ××– ×¦×¨×™×š ×œ×”××™×¨ ××¡×¤×¨ ×œ××—×¨×•×–×ª
  if (branchSelect === 'south') {
    filter += ` and BRANCHNAME le '1'`;
  } else if (branchSelect === 'north') {
    filter += ` and BRANCHNAME ge '3'`;
  }
  
  console.log('Filter:', filter);
  
  // ××™×¤×•×¡
  statusDiv.className = 'status loading';
  statusDiv.innerHTML = '<div class="loader"></div><p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>';
  fetchBtn.disabled = true;
  downloadBtn.disabled = true;
  recordCount.textContent = '0';
  pageCountEl.textContent = '0';
  tableContainer.innerHTML = '';
  currentData = [];
  currentStructuredData = {}; // ××™×¤×•×¡ ×’× × ×ª×•× ×™× ××•×‘× ×™×
  
  try {
    let allData = [];
    let pageSize = 100;
    let skip = 0;
    let pageNum = 0;
    let hasMore = true;
    
    while (hasMore && pageNum < 400) {
      pageNum++;
      const fullFilter = `${filter}&$top=${pageSize}&$skip=${skip}`;
      const url = `${PROXY_URL}?filter=${encodeURIComponent(fullFilter)}`;
      
      console.log(`Fetching page ${pageNum}...`);
      statusDiv.innerHTML = `<div class="loader"></div><p>×˜×•×¢×Ÿ ×“×£ ${pageNum}... (${allData.length} ×¨×©×•××•×ª)</p>`;
      
      const response = await fetch(url);
      
      if (!response.ok) {
        // × ×¡×” ×œ×§×¨×•× ××ª ×”×ª×©×•×‘×” ××”×©×¨×ª ×›×“×™ ×œ×¨××•×ª ××” ×”×‘×¢×™×”
        let errorText = '';
        try {
          errorText = await response.text();
          console.error('Response error:', errorText);
        } catch (e) {
          errorText = '×œ× × ×™×ª×Ÿ ×œ×§×¨×•× ××ª ×”×ª×©×•×‘×”';
        }
        throw new Error(`Error ${response.status}: ${errorText}`);
      }
      
      const jsonData = await response.json();
      const data = jsonData.value || jsonData;
      
      if (!data || data.length === 0) {
        hasMore = false;
      } else {
        allData = allData.concat(data);
        recordCount.textContent = allData.length;
        pageCountEl.textContent = pageNum;
        
        if (data.length < pageSize) {
          hasMore = false;
        } else {
          skip += pageSize;
          await new Promise(r => setTimeout(r, 100));
        }
      }
    }
    
    if (allData.length === 0) {
      statusDiv.className = 'status';
      statusDiv.textContent = '×œ× × ××¦××• × ×ª×•× ×™×';
      tableContainer.innerHTML = '<p style="text-align:center;padding:50px;color:#999;">×œ× × ××¦××• ×”×–×× ×•×ª</p>';
    } else {
      // ×‘×™×¦×•×¢ ×—×™×©×•×‘×™× - ××™×›×œ×™× ×•×××¨×–×™×
      statusDiv.innerHTML = '<div class="loader"></div><p>××‘×¦×¢ ×—×™×©×•×‘×™×...</p>';
      allData = calculateContainersAndPacks(allData);
      
      // ×”××¨×” ×œ××‘× ×” NoSQL - ×§×™×‘×•×¥ ×œ×¤×™ ×”×–×× ×”
      const structuredData = organizeAsNoSQL(allData);
      currentData = allData; // ×©××™×¨×ª ×”× ×ª×•× ×™× ×”×’×•×œ××™×™×
      currentStructuredData = structuredData; // ×©××™×¨×ª ×”× ×ª×•× ×™× ×”××•×‘× ×™×
      
      console.log('âœ… × ×ª×•× ×™× × ××©×›×•:', allData.length, '×¨×©×•××•×ª');
      console.log('âœ… × ×ª×•× ×™× ××•×‘× ×™×:', Object.keys(structuredData).length, '×”×–×× ×•×ª');
      console.log('âœ… ×“×•×’××” ×œ×”×–×× ×”:', Object.values(structuredData)[0]);
      
      createTable(allData);
      // ×™×¦×™×¨×ª ×“×•×—×•×ª × ×•×¡×¤×™× ××”× ×ª×•× ×™× ×”××•×‘× ×™×
      createSummaryReport(structuredData);
      createLabelsReport(structuredData);
      // ×”×¦×’×ª ×˜××‘×™×
      document.getElementById('tabsContainer').style.display = 'flex';
      statusDiv.className = 'status success';
      statusDiv.textContent = `âœ“ ×”×¦×œ×—×”! × ××©×›×• ${allData.length} ×¨×©×•××•×ª (${Object.keys(structuredData).length} ×”×–×× ×•×ª, ${SELECTED_FIELDS.length} ×¢××•×“×•×ª)`;
      downloadBtn.disabled = false;
    }
    
  } catch (error) {
    console.error('Error:', error);
    statusDiv.className = 'status error';
    statusDiv.textContent = `âŒ ×©×’×™××”: ${error.message}`;
  } finally {
    fetchBtn.disabled = false;
  }
}

function createTable(data) {
  const tableContainer = document.getElementById('tableContainer');
  
  // ×× ×™×© ×˜×‘×œ×” ×§×™×™××ª, ×”×©××“ ××•×ª×”
  if (dataTable) {
    dataTable.destroy();
    dataTable = null;
  }
  
  // ×©×™××•×© ×‘×©×“×•×ª ×”× ×‘×—×¨×™×
  const headers = SELECTED_FIELDS;
  
  // ×‘× ×™×™×ª ×”×˜×‘×œ×” - ×›×œ ×©×•×¨×” = ×¤×¨×™×˜
  let html = '<table id="mainTable" class="display nowrap" style="width:100%"><thead><tr>';
  
  // ×™×¦×™×¨×ª ×›×•×ª×¨×•×ª ×‘×¢×‘×¨×™×ª
  headers.forEach(h => {
    const hebrewName = FIELD_NAMES_HEBREW[h] || h;
    html += `<th>${hebrewName}</th>`;
  });
  
  html += '</tr></thead><tbody>';
  
  // ×™×¦×™×¨×ª ×©×•×¨×•×ª ××”× ×ª×•× ×™×
  data.forEach(row => {
    html += '<tr>';
    headers.forEach(field => {
      const value = row[field] !== undefined && row[field] !== null ? row[field] : '';
      html += `<td>${value}</td>`;
    });
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  tableContainer.innerHTML = html;
  
  // ×™×¦×™×¨×ª ×˜×‘×œ×ª DataTables ×¢× ×¡×™× ×•× ×™× ×•×—×™×¤×•×©
  dataTable = $('#mainTable').DataTable({
    language: {
      url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/he.json',
      search: '×—×™×¤×•×© ×‘×›×œ ×”×¢××•×“×•×ª:',
      searchPlaceholder: '×”×§×œ×“ ×œ×—×™×¤×•×©...'
    },
    pageLength: 25,
    order: [],
    scrollX: true,
    dom: 'Bfrtip',
    // ×”×¤×¢×œ×ª ×—×™×¤×•×© ×’×œ×•×‘×œ×™ ×‘×›×œ ×”×¢××•×“×•×ª (×‘×¨×™×¨×ª ××—×“×œ)
    search: {
      smart: true,
      regex: false
    },
    // ×”×•×¡×¤×ª ×¡×™× ×•× ×™× ×œ×›×œ ×¢××•×“×”
    initComplete: function() {
      const api = this.api();
      
      // ×”×•×¡×¤×ª ×©×“×•×ª ×¡×™× ×•×Ÿ ×œ×›×œ ×¢××•×“×”
      api.columns().every(function(index) {
        const column = this;
        const header = $(column.header());
        let title = header.text().trim();
        
        // ×× ×”×›×•×ª×¨×ª ×¨×™×§×” ××• ×œ× ×§×™×™××ª, × ×¡×” ×œ×§×‘×œ ××•×ª×” ××”×¢××•×“×”
        if (!title || title === '') {
          const cells = column.nodes();
          if (cells && cells.length > 0) {
            // × ×¡×” ×œ×§×‘×œ ××ª ×”×›×•×ª×¨×ª ××”×ª× ×”×¨××©×•×Ÿ
            title = '×¢××•×“×” ' + (index + 1);
          }
        }
        
        // ×©××™×¨×ª ×”×›×•×ª×¨×ª ×•×”×—×œ×¤×ª ×”×ª×•×›×Ÿ
        header.html('<div class="header-text">' + title + '</div>');
        
        // ×™×¦×™×¨×ª input ×œ×¡×™× ×•×Ÿ
        const input = $('<input type="text" placeholder="×¡×™× ×•×Ÿ ' + title + '" class="column-filter" />')
          .appendTo(header)
          .on('keyup change', function() {
            const val = this.value;
            if (column.search() !== val) {
              // ×—×™×¤×•×© ×¨×’×™×œ (×œ× regex) ×œ×›×œ ×”×¢××•×“×”
              column.search(val).draw();
            }
          });
      });
    },
    buttons: [
      {
        extend: 'csv',
        text: 'ğŸ“¥ ×”×•×¨×“ CSV',
        filename: () => {
          const branch = document.getElementById('branchSelect').value;
          const branchName = branch === 'south' ? '×“×¨×•×' : branch === 'north' ? '×¦×¤×•×Ÿ' : '×”×›×œ';
          return `priority_${document.getElementById('dateInput').value}_${branchName}`;
        },
        bom: true,
        exportOptions: {
          format: {
            body: (data, row, column, node) => {
              return data;
            }
          }
        }
      }
    ]
  });
}

function downloadCSV() {
  if (currentData.length === 0) {
    alert('××™×Ÿ × ×ª×•× ×™× ×œ×”×•×¨×“×”');
    return;
  }
  
  const headers = SELECTED_FIELDS;
  const hebrewHeaders = headers.map(h => FIELD_NAMES_HEBREW[h] || h);
  let csv = '\uFEFF' + hebrewHeaders.map(h => `"${h}"`).join(',') + '\n';

  currentData.forEach(row => {
    const values = headers.map(h => {
      const v = row[h];
      if (v === null || v === undefined) return '';
      const s = String(v);
      return s.includes(',') || s.includes('"') || s.includes('\n') ? '"' + s.replace(/"/g, '""') + '"' : s;
    });
    csv += values.join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  
  const branch = document.getElementById('branchSelect').value;
  const branchName = branch === 'south' ? '×“×¨×•×' : branch === 'north' ? '×¦×¤×•×Ÿ' : '×”×›×œ';
  link.download = `priority_${document.getElementById('dateInput').value}_${branchName}.csv`;
  
  link.click();
}

// ×¤×•× ×§×¦×™×” ×œ×”×—×œ×¤×ª ×˜××‘×™×
function showTab(tabName, button) {
  // ×”×¡×ª×¨×ª ×›×œ ×”×ª×•×›×Ÿ
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // ×”×¦×’×ª ×”×˜××‘ ×”× ×‘×—×¨
  document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
  if (button) {
    button.classList.add('active');
  }
}

// ×“×•×— ×¡×™×›×•× ×œ×¤×™ ×¤×¨×™×˜ - ×¡×›×™××” ×©×œ ×›××•×ª ××¢×•×’×œ
function createSummaryReport(data) {
  const container = document.getElementById('summaryContainer');
  const branchFilter = document.getElementById('summaryBranchFilter');
  const pspec6Filter = document.getElementById('summaryPSPEC6Filter');
  
  // ×”××¨×” ×œ× ×ª×•× ×™× ×©×˜×•×—×™× ×× ×¦×¨×™×š (×× ×–×” NoSQL)
  const flatData = Array.isArray(data) ? data : Object.values(data).flatMap(order => 
    order.items.map(item => ({
      ...item,
      BRANCHNAME: order.branchName,
      PSPEC6: item.pspec6,
      PSPEC1: item.pspec1,
      PARTNAME: item.partName,
      PARTDES: item.partDes,
      TQUANT: item.tQuant,
      EATQUANT: item.eatQuant,
      SPEC2: order.spec2,
      CARTON_TYPE: item.cartonType || item.Y_37210_5_ESH || order.Y_37210_5_ESH || '',
      PACKMETHODCODE: item.packMethodCode || '',
      CONTAINERS: item.containers || '',
      ORDNAME: order.orderName || ''
    }))
  );
  
  // ××™×¡×•×£ ×¢×¨×›×™× ×™×™×—×•×“×™×™× ×œ×¡×™× ×•× ×™×
  const branches = [...new Set(flatData.map(r => r.BRANCHNAME || '').filter(Boolean))].sort();
  branchFilter.innerHTML = '<option value="">×”×›×œ</option>';
  branches.forEach(branch => {
    const option = document.createElement('option');
    option.value = branch;
    option.textContent = branch;
    branchFilter.appendChild(option);
  });
  
  const pspec6Values = [...new Set(flatData.map(r => r.PSPEC1 || '').filter(Boolean))].sort();
  pspec6Filter.innerHTML = '<option value="">×”×›×œ</option>';
  pspec6Values.forEach(pspec6 => {
    const option = document.createElement('option');
    option.value = pspec6;
    option.textContent = pspec6;
    pspec6Filter.appendChild(option);
  });

  // ××™×¡×•×£ ×¡×•×’×™ ×§×¨×˜×•×Ÿ ×™×™×—×•×“×™×™×
  const cartonFilter = document.getElementById('summaryCartonFilter');
  const cartonTypes = [...new Set(flatData.map(r => (r.CARTON_TYPE || '').toString().trim()).filter(Boolean))].sort();
  cartonFilter.innerHTML = '<option value="">×”×›×œ (×¢× ×¡×•×’ ×§×¨×˜×•×Ÿ)</option>';
  cartonTypes.forEach(ct => {
    const option = document.createElement('option');
    option.value = ct;
    option.textContent = ct;
    cartonFilter.appendChild(option);
  });
  // ×‘×¨×™×¨×ª ××—×“×œ: ×× ×™×© ×¡×•×’ ×§×¨×˜×•×Ÿ ×©××›×™×œ "×—×" â€“ ×œ×‘×—×•×¨ ××•×ª×• ×›×‘×¨×™×¨×ª ××—×“×œ
  const defaultHot = cartonTypes.find(ct => ct.toString().toLowerCase().includes('×—×'));
  if (defaultHot) {
    cartonFilter.value = defaultHot;
  }
  
  // ×©××™×¨×ª × ×ª×•× ×™× ××§×•×¨×™×™×
  window.allSummaryData = flatData;
  
  // ×”×¦×’×” ×¨××©×•× ×™×ª
  applySummaryFilters();
}

function applySummaryFilters() {
  const container = document.getElementById('summaryContainer');
  const branchFilter = document.getElementById('summaryBranchFilter');
  const pspec6Filter = document.getElementById('summaryPSPEC6Filter');
  const cartonFilter = document.getElementById('summaryCartonFilter');
  const packingMethodFilter = document.getElementById('summaryPackingMethodFilter');
  const flatData = window.allSummaryData || [];
  
  // ×¡×™× ×•×Ÿ ×”× ×ª×•× ×™×
  let filteredData = flatData;
  
  if (branchFilter.value) {
    filteredData = filteredData.filter(r => String(r.BRANCHNAME) === branchFilter.value);
  }
  
  // ×¡×™× ×•×Ÿ ×œ×¤×™ ×©×™×˜×ª ××™×¨×•×–
  if (packingMethodFilter && packingMethodFilter.value) {
    if (packingMethodFilter.value === 'tray') {
      // ×—××’×©×™×ª - ×¨×§ ×©×™×˜×ª ××™×¨×•×– "×—××’×©×™×ª 101"
      filteredData = filteredData.filter(r => {
        const packMethod = String(r.PACKMETHODCODE || r.packMethodCode || '').trim();
        return packMethod === '×—××’×©×™×ª 101' || packMethod.includes('×—××’×©×™×ª 101');
      });
    } else if (packingMethodFilter.value === 'bulk') {
      // ×ª×¤×–×•×¨×ª - ×›×œ ×”×©××¨ (×œ× ×—××’×©×™×ª 101)
      filteredData = filteredData.filter(r => {
        const packMethod = String(r.PACKMETHODCODE || r.packMethodCode || '').trim();
        return packMethod !== '×—××’×©×™×ª 101' && !packMethod.includes('×—××’×©×™×ª 101');
      });
    }
  }
  
  // ×× ×œ× × ×‘×—×¨ "×”×›×œ", ×‘×¨×™×¨×ª ××—×“×œ ×”×™× "×¨×§ ×œ× ×¨×™×§"
  if (pspec6Filter.value === 'notempty' || (!pspec6Filter.value || pspec6Filter.value === 'all')) {
    // ×‘×¨×™×¨×ª ××—×“×œ: ×¨×§ ×œ× ×¨×™×§ (×× ×œ× ×‘×—×¨×• ××©×”×• ××—×¨)
    if (!pspec6Filter.value || pspec6Filter.value === 'all') {
      // ×¨×§ ×× ×œ× ×‘×—×¨×• ××©×”×•, × ×¡× ×Ÿ ×¨×™×§
      // ×›××Ÿ × ×©××™×¨ ××ª ×›×œ ×”× ×ª×•× ×™× - ××¤×©×¨ ×œ×©× ×•×ª ×‘×”×ª×× ×œ×“×¨×™×©×”
    } else {
      filteredData = filteredData.filter(r => {
        const pspec1 = String(r.PSPEC1 || r.pspec1 || '').trim();
        return pspec1 !== '' && pspec1 !== 'null' && pspec1 !== 'undefined';
      });
    }
  } else if (pspec6Filter.value && pspec6Filter.value !== 'all') {
    filteredData = filteredData.filter(r => String(r.PSPEC1 || r.pspec1 || '') === pspec6Filter.value);
  }

  // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¡×•×’ ×§×¨×˜×•×Ÿ
  // ×§×•×“× ×›×œ â€“ ××™ ×©××™×Ÿ ×œ×• ×‘×›×œ×œ ×¡×•×’ ×§×¨×˜×•×Ÿ ×œ× ×™×•×¤×™×¢
  filteredData = filteredData.filter(r => {
    const ct = String(r.CARTON_TYPE || '').trim();
    return ct !== '' && ct !== 'null' && ct !== 'undefined';
  });

  // ×× × ×‘×—×¨ ×¡×•×’ ×§×¨×˜×•×Ÿ ×¡×¤×¦×™×¤×™ â€“ ×¡× ×Ÿ ×¨×§ ××•×ª×•
  if (cartonFilter && cartonFilter.value) {
    const selectedCt = cartonFilter.value;
    filteredData = filteredData.filter(r => String(r.CARTON_TYPE || '').trim() === selectedCt);
  }
  
  // ×× × ×‘×—×¨ ×—××’×©×™×ª - ×œ×˜×¤×œ ×‘×œ×•×’×™×§×” ××™×•×—×“×ª ×©×œ ×©×™×œ×•×‘ ×¤×—××™××” ×¢×™×§×¨×™ + ×™×¨×§
  if (packingMethodFilter && packingMethodFilter.value === 'tray') {
    // ×§×™×‘×•×¥ ×œ×¤×™ ×”×–×× ×”
    const ordersMap = {};
    filteredData.forEach(row => {
      const orderName = row.ORDNAME || row.orderName || '×œ×œ×_×”×–×× ×”';
      if (!ordersMap[orderName]) {
        ordersMap[orderName] = [];
      }
      ordersMap[orderName].push(row);
    });
    
    // ×¢×‘×•×¨ ×›×œ ×”×–×× ×” - ×œ××¦×•× ×¤×—××™××” ×¢×™×§×¨×™ ×•×™×¨×§ ×•×œ×©×œ×‘ ××•×ª×
    const combinedItems = [];
    Object.values(ordersMap).forEach(orderItems => {
      let mainCarb = null; // ×¤×—××™××” ×¢×™×§×¨×™
      let vegetable = null; // ×™×¨×§
      
      orderItems.forEach(item => {
        const pspec1 = String(item.PSPEC1 || item.pspec1 || '').toLowerCase();
        if ((pspec1.includes('×¢×™×§×¨') || pspec1.includes('×¢×™×§×¨×™') || pspec1.includes('×¤×—××™××”')) && !pspec1.includes('×™×¨×§')) {
          mainCarb = item;
        } else if (pspec1.includes('×™×¨×§')) {
          vegetable = item;
        }
      });
      
      // ×× ×™×© ×’× ×¤×—××™××” ×¢×™×§×¨×™ ×•×’× ×™×¨×§ - ×œ×©×œ×‘ ××•×ª×
      if (mainCarb && vegetable) {
        const combinedDes = `${mainCarb.PARTDES || mainCarb.partDes || ''}+${vegetable.PARTDES || vegetable.partDes || ''}`;
        const combinedKey = `combined|${combinedDes}`;
        combinedItems.push({
          key: combinedKey,
          partDes: combinedDes,
          pspec1: '×—××’×©×™×ª',
          quantity: parseFloat(mainCarb.TQUANT || mainCarb.tQuant || 0) + parseFloat(vegetable.TQUANT || vegetable.tQuant || 0),
          containers: (parseFloat(mainCarb.CONTAINERS || mainCarb.containers || 0) || 0) + (parseFloat(vegetable.CONTAINERS || vegetable.containers || 0) || 0)
        });
      } else {
        // ×× ××™×Ÿ ×©×™×œ×•×‘, ×œ×”×•×¡×™×£ ××ª ×”×¤×¨×™×˜×™× ×‘× ×¤×¨×“
        orderItems.forEach(item => {
          const pspec1 = String(item.PSPEC1 || item.pspec1 || '').toLowerCase();
          if ((pspec1.includes('×¢×™×§×¨') || pspec1.includes('×¢×™×§×¨×™') || pspec1.includes('×¤×—××™××”')) || pspec1.includes('×™×¨×§')) {
            const key = `${item.PARTNAME || item.partName || '×œ×œ×'}|${item.PARTDES || item.partDes || ''}`;
            combinedItems.push({
              key: key,
              partDes: item.PARTDES || item.partDes || '',
              pspec1: item.PSPEC1 || item.pspec1 || '',
              quantity: parseFloat(item.TQUANT || item.tQuant || 0),
              containers: parseFloat(item.CONTAINERS || item.containers || 0) || 0
            });
          }
        });
      }
    });
    
    // ×§×™×‘×•×¥ ×œ×¤×™ key ×•×¡×™×›×•×
    const summary = {};
    combinedItems.forEach(item => {
      if (!summary[item.key]) {
        summary[item.key] = {
          partDes: item.partDes,
          pspec1: item.pspec1,
          totalQuantity: 0,
          totalContainers: 0
        };
      }
      summary[item.key].totalQuantity += item.quantity;
      summary[item.key].totalContainers += item.containers;
    });
    
    const summaryArray = Object.values(summary).sort((a, b) => {
      const pspec1A = (a.pspec1 || '').toString().toLowerCase();
      const pspec1B = (b.pspec1 || '').toString().toLowerCase();
      return pspec1A.localeCompare(pspec1B);
    });
    
    // ×™×¦×™×¨×ª ×˜×‘×œ×”
    let html = '<table><thead><tr>';
    html += '<th>×¤×¨××˜×¨ 1 ×œ××•×¦×¨</th><th>×ª×™××•×¨ ××•×¦×¨</th><th>×›××•×ª (×¡×”&quot;×›)</th><th>×›××•×ª ××™×›×œ×™×</th>';
    html += '</tr></thead><tbody>';
    
    let grandTotal = 0;
    let grandTotalContainers = 0;
    summaryArray.forEach(item => {
      html += '<tr>';
      html += `<td>${item.pspec1}</td>`;
      html += `<td>${item.partDes}</td>`;
      html += `<td style="font-weight:bold;">${item.totalQuantity.toFixed(2)}</td>`;
      html += `<td style="font-weight:bold;">${item.totalContainers > 0 ? item.totalContainers.toFixed(0) : ''}</td>`;
      html += '</tr>';
      grandTotal += item.totalQuantity;
      grandTotalContainers += item.totalContainers;
    });
    
    html += '<tr style="background:#e8f5e9;font-weight:bold;">';
    html += '<td colspan="2">×¡×”"×› ×›×œ×œ×™</td>';
    html += `<td>${grandTotal.toFixed(2)}</td>`;
    html += `<td>${grandTotalContainers > 0 ? grandTotalContainers.toFixed(0) : ''}</td>`;
    html += '</tr>';
    html += '</tbody></table>';
    
    container.innerHTML = html;
    window.summaryData = summaryArray;
    return;
  }
  
  // ×œ×•×’×™×§×” ×¨×’×™×œ×” (×œ× ×—××’×©×™×ª) - ×§×™×‘×•×¥ ×œ×¤×™ ×¤×¨×™×˜ (PARTNAME) ×•×¡×™×›×•× ×›××•×ª (TQUANT)
  const summary = {};
  
  filteredData.forEach(row => {
    // ×ª××™×›×” ×’× ×‘××‘× ×” NoSQL ×•×’× ×‘××‘× ×” ×©×˜×•×—
    const partName = row.PARTNAME || row.partName || '×œ×œ× ×©×';
    const partDes = row.PARTDES || row.partDes || '';
    const key = `${partName}|${partDes}`;
    const pspec1 = row.PSPEC1 || row.pspec1 || '';
    const quantity = parseFloat(row.TQUANT || row.tQuant || 0) || 0;
    const containers = parseFloat(row.CONTAINERS || row.containers || 0) || 0;
    
    if (!summary[key]) {
      summary[key] = {
        partName: partName,
        partDes: partDes,
        pspec1: pspec1, // ×¤×¨××˜×¨ 1 ×œ××•×¦×¨
        totalQuantity: 0,
        totalContainers: 0
      };
    }
    
    summary[key].totalQuantity += quantity;
    summary[key].totalContainers += containers;
  });
  
  // ×”××¨×” ×œ××¢×¨×š ×•××™×•×Ÿ ×œ×¤×™ ×¤×¨××˜×¨ 1 ×œ××•×¦×¨ ×‘×¡×“×¨ ×¢×•×œ×”
  const summaryArray = Object.values(summary).sort((a, b) => {
    const pspec1A = (a.pspec1 || '').toString().toLowerCase();
    const pspec1B = (b.pspec1 || '').toString().toLowerCase();
    return pspec1A.localeCompare(pspec1B);
  });
  
  // ×™×¦×™×¨×ª ×˜×‘×œ×” (×‘×œ×™ ×¢××•×“×ª ××§×˜, ×¨×§ ×ª×™××•×¨ ××•×¦×¨)
  let html = '<table><thead><tr>';
  html += '<th>×¤×¨××˜×¨ 1 ×œ××•×¦×¨</th><th>×ª×™××•×¨ ××•×¦×¨</th><th>×›××•×ª (×¡×”&quot;×›)</th><th>×›××•×ª ××™×›×œ×™×</th>';
  html += '</tr></thead><tbody>';
  
  let grandTotal = 0;
  let grandTotalContainers = 0;
  summaryArray.forEach(item => {
    html += '<tr>';
    html += `<td>${item.pspec1}</td>`;
    html += `<td>${item.partDes}</td>`;
    html += `<td style="font-weight:bold;">${item.totalQuantity.toFixed(2)}</td>`;
    html += `<td style="font-weight:bold;">${item.totalContainers > 0 ? item.totalContainers.toFixed(0) : ''}</td>`;
    html += '</tr>';
    grandTotal += item.totalQuantity;
    grandTotalContainers += item.totalContainers;
  });
  
  html += '<tr style="background:#e8f5e9;font-weight:bold;">';
  html += '<td colspan="2">×¡×”"×› ×›×œ×œ×™</td>';
  html += `<td>${grandTotal.toFixed(2)}</td>`;
  html += `<td>${grandTotalContainers > 0 ? grandTotalContainers.toFixed(0) : ''}</td>`;
  html += '</tr>';
  html += '</tbody></table>';
  
  container.innerHTML = html;
  
  // ×©××™×¨×ª × ×ª×•× ×™× ×œ×”×•×¨×“×”
  window.summaryData = summaryArray;
}

// ×“×•×— ××“×‘×§×•×ª - ×œ×¤×™ ×§×• ×—×œ×•×§×” ×•×¡×“×¨ ×”×¤×¦×”
function createLabelsReport(data) {
  const container = document.getElementById('labelsContainer');
  const distrLineSelect = document.getElementById('distrLineFilter');
  const packingMethodSelect = document.getElementById('packingMethodFilter');
  const labelsTempSelect = document.getElementById('labelsTempFilter');
  
  // ×× ×–×” NoSQL, ×”××¨×” ×œ× ×ª×•× ×™× ×©×˜×•×—×™×
  const orders = Array.isArray(data) ? null : data;
  const flatData = orders ? Object.values(orders).flatMap(order => 
    order.items.map(item => ({
      ...item,
      ORDNAME: order.orderName,
      DISTRLINECODE: order.distrLineCode,
      DISTRLINEDES: order.distrLineDes,
      PRIT_DISTRORDER: order.pritDistrOrder,
      CODEDES: order.codeDes,
      CUSTDES: order.custDes,
      ADDRESS: order.address,
      STATE: order.state,
      PHONENUM: order.phoneNum,
      EATQUANT: order.eatQuant,
      SPEC2: order.spec2,
      PSPEC2: item.pspec2
    }))
  ) : data;
  
  // ××™×¡×•×£ ×§×•×•×™ ×—×œ×•×§×” ×™×™×—×•×“×™×™×
  const distrLines = [...new Set(flatData.map(r => r.DISTRLINECODE || '').filter(Boolean))].sort();
  distrLineSelect.innerHTML = '<option value="">×”×›×œ</option>';
  distrLines.forEach(line => {
    const option = document.createElement('option');
    option.value = line;
    option.textContent = line;
    distrLineSelect.appendChild(option);
  });
  
  // ××™×¡×•×£ ×©×™×˜×•×ª ××¨×™×–×” ×¨××©×™×•×ª ×™×™×—×•×“×™×•×ª (×œ×¤×™ PSPEC1)
  const packingMethods = new Set();
  if (orders) {
    Object.values(orders).forEach(order => {
      const pspec1Groups = {};
      order.items.forEach(item => {
        if (item.pspec1 && item.packMethodCode) {
          if (!pspec1Groups[item.pspec1]) {
            pspec1Groups[item.pspec1] = item.packMethodCode;
          }
        }
      });
      const firstPSpec1 = Object.keys(pspec1Groups).sort()[0];
      if (firstPSpec1 && pspec1Groups[firstPSpec1]) {
        packingMethods.add(pspec1Groups[firstPSpec1]);
      }
    });
  }
  
  const sortedPackingMethods = Array.from(packingMethods).sort();
  packingMethodSelect.innerHTML = '<option value="">×”×›×œ</option>';
  sortedPackingMethods.forEach(method => {
    const option = document.createElement('option');
    option.value = method;
    option.textContent = method;
    packingMethodSelect.appendChild(option);
  });
  
  // ×¤×•× ×§×¦×™×” ×œ×¡×™× ×•×Ÿ
  const applyFilters = () => {
    const selectedLine = distrLineSelect.value;
    const selectedPackingMethod = packingMethodSelect.value;
    const labelsMode = labelsTempSelect.value || 'all';
    
    if (orders) {
      // ×¢×‘×•×“×” ×¢× ××‘× ×” NoSQL
      let filteredOrders = orders;
      
      if (selectedLine) {
        filteredOrders = Object.fromEntries(Object.entries(filteredOrders).filter(([key, order]) => 
          order.distrLineCode === selectedLine
        ));
      }
      
      if (selectedPackingMethod) {
        filteredOrders = Object.fromEntries(Object.entries(filteredOrders).filter(([key, order]) => {
          // ××¦×™××ª ×©×™×˜×ª ××¨×™×–×” ×¨××©×™×ª ×œ×¤×™ PSPEC1
          const pspec1Groups = {};
          order.items.forEach(item => {
            if (item.pspec1 && item.packMethodCode) {
              if (!pspec1Groups[item.pspec1]) {
                pspec1Groups[item.pspec1] = item.packMethodCode;
              }
            }
          });
          const firstPSpec1 = Object.keys(pspec1Groups).sort()[0];
          const mainPackingMethod = firstPSpec1 && pspec1Groups[firstPSpec1] ? pspec1Groups[firstPSpec1] : '';
          return mainPackingMethod === selectedPackingMethod;
        }));
      }
      
      renderLabelsTableNoSQL(filteredOrders, container, labelsMode);
    } else {
      let filtered = flatData;
      if (selectedLine) {
        filtered = filtered.filter(r => r.DISTRLINECODE === selectedLine);
      }
      // ×¡×™× ×•×Ÿ ×œ×¤×™ ×©×™×˜×ª ××¨×™×–×” ×¨××©×™×ª ×‘× ×ª×•× ×™× ×©×˜×•×—×™× ×™×•×ª×¨ ××•×¨×›×‘, × ×¢×©×” ×œ×¤×™ ×”×–×× ×”
      if (selectedPackingMethod) {
        const ordersByPackingMethod = {};
        filtered.forEach(r => {
          const orderKey = r.ORDNAME;
          if (!ordersByPackingMethod[orderKey]) {
            ordersByPackingMethod[orderKey] = [];
          }
          ordersByPackingMethod[orderKey].push(r);
        });
        
        const filteredOrders = {};
        Object.keys(ordersByPackingMethod).forEach(orderKey => {
          const orderItems = ordersByPackingMethod[orderKey];
          const pspec1Groups = {};
          orderItems.forEach(item => {
            if (item.PSPEC1 && item.PACKMETHODCODE) {
              if (!pspec1Groups[item.PSPEC1]) {
                pspec1Groups[item.PSPEC1] = item.PACKMETHODCODE;
              }
            }
          });
          const firstPSpec1 = Object.keys(pspec1Groups).sort()[0];
          const mainPackingMethod = firstPSpec1 && pspec1Groups[firstPSpec1] ? pspec1Groups[firstPSpec1] : '';
          if (mainPackingMethod === selectedPackingMethod) {
            filteredOrders[orderKey] = orderItems;
          }
        });
        filtered = Object.values(filteredOrders).flat();
      }
      renderLabelsTable(filtered, container);
    }
  };
  
  // ×”×•×¡×¤×ª event listeners ×œ×¡×™× ×•×Ÿ
  distrLineSelect.onchange = applyFilters;
  packingMethodSelect.onchange = applyFilters;
  labelsTempSelect.onchange = applyFilters;
  
  // ×”×¦×’×” ×¨××©×•× ×™×ª
  if (orders) {
    renderLabelsTableNoSQL(orders, container, labelsTempSelect.value || 'all');
    window.labelsData = orders;
  } else {
    renderLabelsTable(flatData, container);
    window.labelsData = flatData;
  }
}

// ×¨×™× ×“×•×¨ ×“×•×— ××“×‘×§×•×ª ×××‘× ×” NoSQL (×™×•×ª×¨ × ×§×™ ×•×™×¢×™×œ)
function renderLabelsTableNoSQL(orders, container, labelsMode = 'all') {
  // ×”××¨×” ×œ××¢×¨×š ×•××™×•×Ÿ ×œ×¤×™ ×§×• ×—×œ×•×§×”, ×¡×“×¨ ×”×¤×¦×” ×•×”×–×× ×”
  const ordersArray = Object.values(orders).sort((a, b) => {
    if (a.distrLineCode !== b.distrLineCode) return (a.distrLineCode || '').localeCompare(b.distrLineCode || '');
    if (a.pritDistrOrder !== b.pritDistrOrder) return (a.pritDistrOrder || 0) - (b.pritDistrOrder || 0);
    return (a.orderName || '').localeCompare(b.orderName || '');
  });
  
  let html = '';
  
  ordersArray.forEach(order => {
    // ×–×™×”×•×™ ×©×™×˜×ª ××¨×™×–×” ×¢×™×§×¨×™×ª ×œ×¤×™ PSPEC1 - ××—×¤×© ×¤×¨×™×˜ ×¢× "×¢×™×§×¨" ×‘×¤×¨××˜×¨ 1
    let mainPackingMethod = '';
    order.items.forEach(item => {
      if (item.pspec1 && item.packMethodCode) {
        const pspec1Str = (item.pspec1 || '').toString().toLowerCase();
        // ×× ×¤×¨××˜×¨ 1 ××›×™×œ ××ª ×”××™×œ×” "×¢×™×§×¨" - ×–×” ×”×¤×¨×™×˜ ×”×¢×™×§×¨×™
        if (pspec1Str.includes('×¢×™×§×¨') && !mainPackingMethod) {
          mainPackingMethod = item.packMethodCode || '';
        }
      }
    });
    
    // ×× ×œ× ××¦×× ×• ×¤×¨×™×˜ ×¢× "×¢×™×§×¨", × ×™×§×— ××ª ×”×¨××©×•×Ÿ
    if (!mainPackingMethod) {
      const pspec1Groups = {};
      order.items.forEach(item => {
        if (item.pspec1 && item.packMethodCode) {
          if (!pspec1Groups[item.pspec1] || !pspec1Groups[item.pspec1].packMethodCode) {
            pspec1Groups[item.pspec1] = {
              packMethodCode: item.packMethodCode || ''
            };
          }
        }
      });
      const firstPSpec1 = Object.keys(pspec1Groups).sort()[0];
      if (firstPSpec1 && pspec1Groups[firstPSpec1]) {
        mainPackingMethod = pspec1Groups[firstPSpec1].packMethodCode || '';
      }
    }
    
    // ×–×™×”×•×™ ×× ×™×© ××œ×¨×’× ×™×/×¦××—×•× ×™
    const hasNoAllergen = (order.eatQuantNoAllergen || 0) > 0;
    const isVegetarian = (order.spec2 && order.spec2.toString().toLowerCase().includes('×¦××—×•× ×™')) ||
                        (order.spec2 && order.spec2.toString().toLowerCase().includes('×¦××—×•× ×•×ª'));
    
    // ×”×¤×¨×“×” ×‘×™×Ÿ ×¤×¨×™×˜×™× ×§×¨ ×•×—× ×œ×¤×™ PSPEC6
    const coldItemsMap = {}; // {partKey: {sumQuant, sumContainers, sumPack5, sumPack7, partDes}}
    const hotItemsMap = {};
    
    order.items.forEach(item => {
      // ×¨×§ ×¤×¨×™×˜×™× ×©×™×© ×œ×”× ×¡×•×’ ×§×¨×˜×•×Ÿ
      if (!item.cartonType) return;

      const cartonStr = (item.cartonType || '').toString().toLowerCase();
      const pspec6Str = (item.pspec6 || '').toString().toLowerCase();
      
      // ×–×™×”×•×™ ×× ×–×” ×§×¨×˜×•×Ÿ ×—× ××• ×§×¨ - ×§×•×“× ×›×œ ×‘×•×“×§×™× ××ª ×¡×•×’ ×”×§×¨×˜×•×Ÿ
      let isHot = false;
      
      // ×§×•×“× ×‘×•×“×§×™× ××ª ×¡×•×’ ×”×§×¨×˜×•×Ÿ - ×¢×“×™×¤×•×ª ×¨××©×•× ×”
      if (cartonStr.includes('×—×') || cartonStr.includes('×—××™×')) {
        isHot = true;
      } else if (cartonStr.includes('×§×¨') || cartonStr.includes('×§×¨×™×')) {
        isHot = false;
      } else {
        // ×¨×§ ×× ××™×Ÿ ××™× ×“×™×§×¦×™×” ×‘×¨×•×¨×” ×‘×¡×•×’ ×”×§×¨×˜×•×Ÿ, ×‘×•×“×§×™× ××ª PSPEC6
        isHot = pspec6Str.includes('×—×') || pspec6Str.includes('×—××™×');
      }
      
      const partKey = `${item.partName}|${item.partDes}`;
      const itemsMap = isHot ? hotItemsMap : coldItemsMap;
      
      if (!itemsMap[partKey]) {
        itemsMap[partKey] = {
          partName: item.partName,
          partDes: item.partDes,
          cartonType: item.cartonType || '',
          sumQuant: 0,
          sumContainers: 0,
          sumPack5: 0,
          sumPack7: 0
        };
      }
      
      // ×¡×™×›×•× ×”×›××•×™×•×ª
      itemsMap[partKey].sumQuant += parseFloat(item.tQuant) || 0;
      
      // ×¡×™×›×•× ××™×›×œ×™× - ×× ×™×© ×¤×¨××˜×¨ 7 (CONTAINERS)
      if (item.containers !== '' && item.containers !== null && item.containers !== undefined) {
        itemsMap[partKey].sumContainers += parseFloat(item.containers) || 0;
      }
      
      // ×¡×™×›×•× ×××¨×– 5 - ×× ×™×© ×¤×¨××˜×¨ 8 (PACK5)
      if (item.pack5 !== '' && item.pack5 !== null && item.pack5 !== undefined) {
        itemsMap[partKey].sumPack5 += parseFloat(item.pack5) || 0;
      }
      
      // ×¡×™×›×•× ×××¨×– 7 - ×× ×™×© ×¤×¨××˜×¨ 8 (PACK7)
      if (item.pack7 !== '' && item.pack7 !== null && item.pack7 !== undefined) {
        itemsMap[partKey].sumPack7 += parseFloat(item.pack7) || 0;
      }
    });

    // ×× ××™×Ÿ ×‘×›×œ×œ ×¤×¨×™×˜×™× ×¢× ×¡×•×’ ×§×¨×˜×•×Ÿ - ×œ×“×œ×’ ×¢×œ ×”×”×–×× ×”
    if (Object.keys(coldItemsMap).length === 0 && Object.keys(hotItemsMap).length === 0) {
      return;
    }

    // ×¤×•× ×§×¦×™×” ×¤× ×™××™×ª ×œ×™×¦×™×¨×ª ××“×‘×§×” ×œ×§×¨×˜×•×Ÿ ××¡×•×™× (×§×¨/×—×)
    const renderCartonSticker = (itemsMap, title, isHotCarton) => {
      if (Object.keys(itemsMap).length === 0) return;

      const firstItem = Object.values(itemsMap)[0];
      const cartonTypeText = firstItem.cartonType || '';

      html += '<div class="label-card" style="border:2px solid #333;padding:10px;background:#f9f9f9;">';
      html += '<table style="width:100%;border-collapse:collapse;"><tbody>';
      
      // ×©×•×¨×” ×¨××©×•× ×” - ×¤×¨×˜×™× ×¢×™×§×¨×™×™× (×¨×§ × ×ª×•× ×™×, ×‘×œ×™ ×›×•×ª×¨×•×ª)
      html += '<tr>';
      html += `<td>${order.dueDate || ''}</td>`;
      html += `<td>${order.custName || ''}</td>`;
      html += `<td><strong>${order.custDes || ''}</strong></td>`;
      html += `<td>${order.codeDes || ''}</td>`;
      html += `<td>${order.spec1 || ''}</td>`;
      html += `<td>${mainPackingMethod || ''}</td>`;
      html += '</tr>';
      
      // ×©×•×¨×” ×©× ×™×™×” - ×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×§ × ×ª×•× ×™×, ×‘×œ×™ ×›×•×ª×¨×•×ª)
      html += '<tr>';
      html += `<td>${order.address || ''}</td>`;
      html += `<td>${order.distrLineCode || ''} ${order.distrLineDes || ''}</td>`;
      html += `<td>${order.pritDistrOrder || 0}</td>`;
      html += `<td>${order.state || ''}</td>`;
      html += `<td>${order.spec2 || ''}</td>`;
      html += `<td>${(order.eatQuant || 0).toFixed(0)}`;
      if (hasNoAllergen) {
        html += ` / ×œ×œ× ××œ×¨×’× ×™×: ${(order.eatQuantNoAllergen || 0).toFixed(0)}`;
      }
      if (isVegetarian) {
        html += ` / ×¦××—×•× ×™`;
      }
      html += '</td>';
      html += '</tr>';
      
      // ×©×•×¨×” ×©×œ×™×©×™×ª - ×¡×•×’ ×§×¨×˜×•×Ÿ + ×›×•×ª×¨×ª ××“×‘×§×”
      html += '<tr>';
      html += `<td colspan="3">${cartonTypeText || (isHotCarton ? '×§×¨×˜×•×Ÿ ×—×' : '×§×¨×˜×•×Ÿ ×§×¨')}</td>`;
      html += `<td colspan="3"><strong>${title}</strong></td>`;
      html += '</tr>';
      
      html += '</tbody></table>';

      // ×˜×‘×œ×ª ×¤×¨×™×˜×™× - ××™××™×Ÿ ×œ×©×××œ (×ª×™××•×¨ ××•×¦×¨ ××™××™×Ÿ, ×›××•×ª ××©×××œ)
      html += '<table style="width:100%;border-collapse:collapse;margin-top:10px;direction:rtl;"><thead><tr style="background:#e3f2fd;">';
      html += '<th style="border:1px solid #ccc;padding:8px;">×ª×™××•×¨ ××•×¦×¨</th>';
      if (isHotCarton) {
        html += '<th style="border:1px solid #ccc;padding:8px;">×××¨×– 7</th>';
        html += '<th style="border:1px solid #ccc;padding:8px;">××™×›×œ×™× / ×××¨×– 5</th>';
      }
      html += '<th style="border:1px solid #ccc;padding:8px;">×›××•×ª</th>';
      html += '</tr></thead><tbody>';
      
      Object.values(itemsMap).forEach(item => {
        html += '<tr>';
        html += `<td style="border:1px solid #ccc;padding:8px;">${item.partDes || ''}</td>`;
        if (isHotCarton) {
          html += `<td style="border:1px solid #ccc;padding:8px;">${item.sumPack7 > 0 ? item.sumPack7 : ''}</td>`;
          const containersOrPack5 = item.sumContainers > 0 ? item.sumContainers : (item.sumPack5 > 0 ? item.sumPack5 : '');
          html += `<td style="border:1px solid #ccc;padding:8px;">${containersOrPack5 || ''}</td>`;
        }
        html += `<td style="border:1px solid #ccc;padding:8px;">${item.sumQuant.toFixed(2)}</td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      html += '</div>';
    };

    // ××“×‘×§×” ×œ×§×¨×˜×•×Ÿ ×§×¨ / ×—× ×œ×¤×™ ×‘×—×™×¨×ª ×”××©×ª××©
    if (labelsMode === 'all' || labelsMode === 'cold') {
      renderCartonSticker(coldItemsMap, '×§×¨×˜×•×Ÿ ×œ×§×¨', false);
    }
    if (labelsMode === 'all' || labelsMode === 'hot') {
      renderCartonSticker(hotItemsMap, '×§×¨×˜×•×Ÿ ×œ×—×', true);
    }
  });
  
  container.innerHTML = html;
  
  // ×©××™×¨×” ×œ××˜×¨×•×ª CSV
  window.labelsGroupedData = ordersArray;
}

function renderLabelsTable(data, container) {
  // ×§×™×‘×•×¥ ×œ×¤×™ ×§×• ×—×œ×•×§×”, ×¡×“×¨ ×”×¤×¦×” ×•×”×–×× ×”
  const grouped = {};
  
  data.forEach(row => {
    const distrLine = row.DISTRLINECODE || '×œ×œ×';
    const distrOrder = row.PRIT_DISTRORDER || 0;
    const orderName = row.ORDNAME || '×œ×œ×';
    const key = `${distrLine}|${distrOrder}|${orderName}`;
    
    if (!grouped[key]) {
      // ×›××•×ª ×× ×•×ª - ×œ×§×—×ª ×¨×§ ×¤×¢× ××—×ª ×œ×›×œ ×”×–×× ×” (×œ× ×œ×›×¤×•×œ ×œ×¤×™ ×¤×¨×™×˜×™×)
      const eatQuant = parseFloat(row.EATQUANT) || 0;
      
      grouped[key] = {
        distrLine: distrLine,
        distrLineDes: row.DISTRLINEDES || '',
        distrOrder: distrOrder,
        orderName: orderName,
        codeDes: row.CODEDES || '', // ×ª×™××•×¨ ××ª×¨
        customerName: row.CUSTDES || '',
        address: row.ADDRESS || '',
        city: row.STATE || '',
        phone: row.PHONENUM || '',
        eatQuant: eatQuant, // ×›××•×ª ×× ×•×ª - ×¨×§ ×¤×¢× ××—×ª ×œ×›×œ ×”×–×× ×”
        eatQuantNoAllergen: 0, // ×›××•×ª ×× ×•×ª ×œ×œ× ××œ×¨×’× ×™
        coldItems: {}, // ×× ×•×ª ×§×¨ - ××•×‘×™×™×§×˜ ×œ×¡×›×™××” ×œ×¤×™ ××§×˜
        hotItems: {},   // ×× ×•×ª ×—× - ××•×‘×™×™×§×˜ ×œ×¡×›×™××” ×œ×¤×™ ××§×˜
        noAllergenColdItems: {}, // ×× ×•×ª ×§×¨ ×œ×œ× ××œ×¨×’× ×™
        noAllergenHotItems: {}   // ×× ×•×ª ×—× ×œ×œ× ××œ×¨×’× ×™
      };
    }
    
    // ×–×™×”×•×™ ×× ×–×” ×§×¨ ××• ×—× ×œ×¤×™ PSPEC6 ××• ×©×“×” ××—×¨
    const isHot = (row.PSPEC6 && row.PSPEC6.toString().toLowerCase().includes('×—×')) || 
                  (row.PSPEC3 && row.PSPEC3.toString().toLowerCase().includes('×—×'));
    
    // ×–×™×”×•×™ ×× ×–×” ×œ×œ× ××œ×¨×’× ×™ - × ×‘×“×•×§ ×‘-SPEC2 ××• PSPEC2
    const isNoAllergen = (row.SPEC2 && row.SPEC2.toString().toLowerCase().includes('×œ×œ× ××œ×¨×’× ×™')) ||
                         (row.PSPEC2 && row.PSPEC2.toString().toLowerCase().includes('×œ×œ× ××œ×¨×’× ×™')) ||
                         (row.SPEC2 && row.SPEC2.toString().toLowerCase().includes('×œ× ××œ×¨×’× ×™')) ||
                         (row.PSPEC2 && row.PSPEC2.toString().toLowerCase().includes('×œ× ××œ×¨×’× ×™'));
    
    const partName = row.PARTNAME || '';
    const partDes = row.PARTDES || '';
    const partKey = `${partName}|${partDes}`;
    
    // ×× ×™×© ×œ×œ× ××œ×¨×’× ×™, ×œ×”×•×¡×™×£ ×œ×›××•×ª ×× ×•×ª × ×¤×¨×“×ª
    if (isNoAllergen) {
      const eatQuant = parseFloat(row.EATQUANT) || 0;
      if (eatQuant > 0) {
        // ×× ×–×• ×”×¤×¢× ×”×¨××©×•× ×” ×©××•×¦××™× ×œ×œ× ××œ×¨×’× ×™ ×‘×”×–×× ×” ×–×•, × ×§×— ××ª ×”×›××•×ª
        // ×× ×™×© ×¢×•×“ ×©×•×¨×•×ª ×œ×œ× ××œ×¨×’× ×™, × ×¡×›× ××ª ×”×›××•×™×•×ª
        if (grouped[key].eatQuantNoAllergen === 0) {
          // ×”×¤×¢× ×”×¨××©×•× ×” - × ×§×— ××ª ×”×›××•×ª ××”×©×•×¨×” ×”×¨××©×•× ×”
          grouped[key].eatQuantNoAllergen = eatQuant;
        } else {
          // ×›×‘×¨ ×™×© ×›××•×ª - × ×•×¡×™×£ ×¨×§ ×× ×”×›××•×ª ×’×“×•×œ×” ×™×•×ª×¨ (×›×™ ×›×œ ×©×•×¨×” ×™×›×•×œ×” ×œ×”×™×•×ª ×× ×” ×©×•× ×”)
          // ××• × ×©×ª××© ×‘×›××•×ª ×”××§×¡×™××œ×™×ª
          grouped[key].eatQuantNoAllergen = Math.max(grouped[key].eatQuantNoAllergen, eatQuant);
        }
      }
      
      // ×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×¨×©×™××ª ×œ×œ× ××œ×¨×’× ×™
      if (isHot) {
        if (!grouped[key].noAllergenHotItems[partKey]) {
          grouped[key].noAllergenHotItems[partKey] = {
            partName: partName,
            partDes: partDes
          };
        }
      } else {
        if (!grouped[key].noAllergenColdItems[partKey]) {
          grouped[key].noAllergenColdItems[partKey] = {
            partName: partName,
            partDes: partDes
          };
        }
      }
    } else {
      // ×¤×¨×™×˜ ×¨×’×™×œ
      if (isHot) {
        if (!grouped[key].hotItems[partKey]) {
          grouped[key].hotItems[partKey] = {
            partName: partName,
            partDes: partDes
          };
        }
      } else {
        if (!grouped[key].coldItems[partKey]) {
          grouped[key].coldItems[partKey] = {
            partName: partName,
            partDes: partDes
          };
        }
      }
    }
  });
  
  // ×”××¨×” ×œ××¢×¨×š ×•××™×•×Ÿ
  const groupedArray = Object.values(grouped).sort((a, b) => {
    if (a.distrLine !== b.distrLine) return a.distrLine.localeCompare(b.distrLine);
    if (a.distrOrder !== b.distrOrder) return a.distrOrder - b.distrOrder;
    return a.orderName.localeCompare(b.orderName);
  });
  
  // ×™×¦×™×¨×ª ×˜×‘×œ×”
  let html = '<table><thead><tr>';
  html += '<th>×§×• ×—×œ×•×§×”</th><th>×¡×“×¨ ×”×¤×¦×”</th><th>×”×–×× ×”</th><th>×ª×™××•×¨ ××ª×¨</th><th>×œ×§×•×—</th>';
  html += '<th>×›×ª×•×‘×ª</th><th>×¢×™×¨</th><th>×˜×œ×¤×•×Ÿ</th>';
  html += '<th>×× ×•×ª ×§×¨</th><th>×× ×•×ª ×—×</th><th>×¡×”"×› ×× ×•×ª</th>';
  html += '<th>×× ×•×ª ×§×¨ ×œ×œ× ××œ×¨×’× ×™</th><th>×× ×•×ª ×—× ×œ×œ× ××œ×¨×’× ×™</th><th>×¡×”"×› ×× ×•×ª ×œ×œ× ××œ×¨×’× ×™</th>';
  html += '</tr></thead><tbody>';
  
  groupedArray.forEach(group => {
    html += '<tr style="background:#f0f0f0;">';
    html += `<td><strong>${group.distrLine}</strong><br>${group.distrLineDes}</td>`;
    html += `<td>${group.distrOrder}</td>`;
    html += `<td><strong>${group.orderName}</strong></td>`;
    html += `<td>${group.codeDes}</td>`; // ×ª×™××•×¨ ××ª×¨
    html += `<td>${group.customerName}</td>`;
    html += `<td>${group.address}</td>`;
    html += `<td>${group.city}</td>`;
    html += `<td>${group.phone}</td>`;
    
    // ×× ×•×ª ×§×¨ - ×”××¨×” ×××•×‘×™×™×§×˜ ×œ××¢×¨×š (×¨×§ ×¨×©×™××ª ×¤×¨×™×˜×™×, ×‘×œ×™ ×›××•×ª)
    const coldItemsArray = Object.values(group.coldItems || {});
    let coldText = coldItemsArray.map(item => item.partDes).join('<br>');
    const coldCount = coldItemsArray.length;
    html += `<td>${coldText || '-'}${coldCount > 0 ? `<br><small>(${coldCount} ×¤×¨×™×˜×™×)</small>` : ''}</td>`;
    
    // ×× ×•×ª ×—× - ×”××¨×” ×××•×‘×™×™×§×˜ ×œ××¢×¨×š (×¨×§ ×¨×©×™××ª ×¤×¨×™×˜×™×, ×‘×œ×™ ×›××•×ª)
    const hotItemsArray = Object.values(group.hotItems || {});
    let hotText = hotItemsArray.map(item => item.partDes).join('<br>');
    const hotCount = hotItemsArray.length;
    html += `<td>${hotText || '-'}${hotCount > 0 ? `<br><small>(${hotCount} ×¤×¨×™×˜×™×)</small>` : ''}</td>`;
    
    // ×¡×”"×› ×× ×•×ª - ×”×›××•×ª ××”×–×× ×” (×œ× ××•×›×¤×œ)
    const totalQty = group.eatQuant.toFixed(0);
    html += `<td style="font-weight:bold;background:#e8f5e9;">${totalQty}</td>`;
    
    // ×× ×•×ª ×§×¨ ×œ×œ× ××œ×¨×’× ×™
    const noAllergenColdArray = Object.values(group.noAllergenColdItems || {});
    let noAllergenColdText = noAllergenColdArray.map(item => item.partDes).join('<br>');
    const noAllergenColdCount = noAllergenColdArray.length;
    html += `<td style="background:#fff9c4;">${noAllergenColdText || '-'}${noAllergenColdCount > 0 ? `<br><small>(${noAllergenColdCount} ×¤×¨×™×˜×™×)</small>` : ''}</td>`;
    
    // ×× ×•×ª ×—× ×œ×œ× ××œ×¨×’× ×™
    const noAllergenHotArray = Object.values(group.noAllergenHotItems || {});
    let noAllergenHotText = noAllergenHotArray.map(item => item.partDes).join('<br>');
    const noAllergenHotCount = noAllergenHotArray.length;
    html += `<td style="background:#fff9c4;">${noAllergenHotText || '-'}${noAllergenHotCount > 0 ? `<br><small>(${noAllergenHotCount} ×¤×¨×™×˜×™×)</small>` : ''}</td>`;
    
    // ×¡×”"×› ×× ×•×ª ×œ×œ× ××œ×¨×’× ×™
    const totalNoAllergenQty = (group.eatQuantNoAllergen || 0).toFixed(0);
    html += `<td style="font-weight:bold;background:#fff9c4;">${totalNoAllergenQty > 0 ? totalNoAllergenQty : '-'}</td>`;
    
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
  
  window.labelsGroupedData = groupedArray;
}

// ×”×•×¨×“×ª CSV ×œ×“×•×— ×¡×™×›×•×
function downloadSummaryCSV() {
  if (!window.summaryData || window.summaryData.length === 0) {
    alert('××™×Ÿ × ×ª×•× ×™× ×œ×”×•×¨×“×”');
    return;
  }
  
  let csv = '\uFEFF×¤×¨××˜×¨ 1 ×œ××•×¦×¨,×ª×™××•×¨ ××•×¦×¨,×›××•×ª (×¡×”"×›),×›××•×ª ××™×›×œ×™×\n';
  
  let grandTotal = 0;
  let grandTotalContainers = 0;
  window.summaryData.forEach(item => {
    const partName = item.partName || '';
    csv += `"${item.pspec1 || ''}","${item.partDes || ''}",${item.totalQuantity.toFixed(2)},${(item.totalContainers || 0) > 0 ? (item.totalContainers || 0).toFixed(0) : ''}\n`;
    grandTotal += item.totalQuantity;
    grandTotalContainers += (item.totalContainers || 0);
  });
  
  csv += `"×¡×”"×› ×›×œ×œ×™","",${grandTotal.toFixed(2)},${grandTotalContainers > 0 ? grandTotalContainers.toFixed(0) : ''}\n`;
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `summary_${document.getElementById('dateInput').value}.csv`;
  link.click();
}

// ×”×•×¨×“×ª CSV ×œ×“×•×— ××“×‘×§×•×ª
function downloadLabelsCSV() {
  if (!window.labelsGroupedData || window.labelsGroupedData.length === 0) {
    alert('××™×Ÿ × ×ª×•× ×™× ×œ×”×•×¨×“×”');
    return;
  }
  
  let csv = '\uFEFF×§×• ×—×œ×•×§×”,×ª×™××•×¨ ×§×• ×—×œ×•×§×”,×¡×“×¨ ×”×¤×¦×”,×”×–×× ×”,×ª×™××•×¨ ××ª×¨,×œ×§×•×—,×›×ª×•×‘×ª,×¢×™×¨,×˜×œ×¤×•×Ÿ,×× ×•×ª ×§×¨,×× ×•×ª ×—×,×¡×”"×› ×× ×•×ª,×× ×•×ª ×§×¨ ×œ×œ× ××œ×¨×’× ×™,×× ×•×ª ×—× ×œ×œ× ××œ×¨×’× ×™,×¡×”"×› ×× ×•×ª ×œ×œ× ××œ×¨×’× ×™\n';
  
  // ×‘×“×™×§×” ×× ×–×” ××‘× ×” NoSQL (orderName ×§×™×™×) ××• ××‘× ×” ×©×˜×•×—
  if (window.labelsGroupedData[0] && window.labelsGroupedData[0].orderName) {
    // ××‘× ×” NoSQL - ×›×‘×¨ ××¢×•×‘×“
    window.labelsGroupedData.forEach(order => {
      // ×”×¤×¨×“×” ×‘×™×Ÿ ×¤×¨×™×˜×™× ×§×¨ ×•×—×
      const coldItems = [];
      const hotItems = [];
      const noAllergenColdItems = [];
      const noAllergenHotItems = [];
      
      order.items.forEach(item => {
        const isHot = (item.pspec6 && item.pspec6.toString().toLowerCase().includes('×—×')) || 
                      (item.pspec3 && item.pspec3.toString().toLowerCase().includes('×—×'));
        const isNoAllergen = (order.spec2 && order.spec2.toString().toLowerCase().includes('×œ×œ× ××œ×¨×’× ×™')) ||
                             (item.pspec2 && item.pspec2.toString().toLowerCase().includes('×œ×œ× ××œ×¨×’× ×™'));
        
        const partKey = `${item.partName}|${item.partDes}`;
        
        if (isNoAllergen) {
          if (isHot) {
            if (!noAllergenHotItems.find(i => `${i.partName}|${i.partDes}` === partKey)) {
              noAllergenHotItems.push({ partName: item.partName, partDes: item.partDes });
            }
          } else {
            if (!noAllergenColdItems.find(i => `${i.partName}|${i.partDes}` === partKey)) {
              noAllergenColdItems.push({ partName: item.partName, partDes: item.partDes });
            }
          }
        } else {
          if (isHot) {
            if (!hotItems.find(i => `${i.partName}|${i.partDes}` === partKey)) {
              hotItems.push({ partName: item.partName, partDes: item.partDes });
            }
          } else {
            if (!coldItems.find(i => `${i.partName}|${i.partDes}` === partKey)) {
              coldItems.push({ partName: item.partName, partDes: item.partDes });
            }
          }
        }
      });
      
      const coldText = coldItems.map(item => item.partDes).join('; ');
      const hotText = hotItems.map(item => item.partDes).join('; ');
      const noAllergenColdText = noAllergenColdItems.map(item => item.partDes).join('; ');
      const noAllergenHotText = noAllergenHotItems.map(item => item.partDes).join('; ');
      
      csv += `"${order.distrLineCode || ''}","${order.distrLineDes || ''}",${order.pritDistrOrder || 0},"${order.orderName || ''}","${order.codeDes || ''}","${order.custDes || ''}","${order.address || ''}","${order.state || ''}","${order.phoneNum || ''}","${coldText}","${hotText}","${(order.eatQuant || 0).toFixed(0)}","${noAllergenColdText}","${noAllergenHotText}","${(order.eatQuantNoAllergen || 0).toFixed(0)}"\n`;
    });
  } else {
    // ××‘× ×” ×©×˜×•×— (legacy)
    window.labelsGroupedData.forEach(group => {
      const coldItemsArray = Object.values(group.coldItems || {});
      const hotItemsArray = Object.values(group.hotItems || {});
      const coldText = coldItemsArray.map(item => item.partDes).join('; ');
      const hotText = hotItemsArray.map(item => item.partDes).join('; ');
      const totalQty = (group.eatQuant || 0).toFixed(0);
      
      const noAllergenColdArray = Object.values(group.noAllergenColdItems || {});
      const noAllergenHotArray = Object.values(group.noAllergenHotItems || {});
      const noAllergenColdText = noAllergenColdArray.map(item => item.partDes).join('; ');
      const noAllergenHotText = noAllergenHotArray.map(item => item.partDes).join('; ');
      const totalNoAllergenQty = (group.eatQuantNoAllergen || 0).toFixed(0);
      
      csv += `"${group.distrLine}","${group.distrLineDes}",${group.distrOrder},"${group.orderName}","${group.codeDes || ''}","${group.customerName}","${group.address}","${group.city}","${group.phone}","${coldText}","${hotText}","${totalQty}","${noAllergenColdText}","${noAllergenHotText}","${totalNoAllergenQty}"\n`;
    });
  }
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `labels_${document.getElementById('dateInput').value}.csv`;
  link.click();
}

// ××©×ª× ×” ×œ××—×¡×•×Ÿ ×˜×‘×œ×ª DataTables
let dataTable = null;

// ========== ××•×¤×˜×™××™×–×¦×™×™×ª ××¨×™×–×” ==========

// ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ×-localStorage ××• ×™×¦×™×¨×ª ×‘×¨×™×¨×ª ××—×“×œ
function loadPackingSettings() {
  let productsSettings = JSON.parse(localStorage.getItem('packingProductsSettings') || '{}');
  let containersSettings = JSON.parse(localStorage.getItem('packingContainersSettings') || '[]');
  
  // ×× ××™×Ÿ ×”×’×“×¨×•×ª, ×™×¦×™×¨×ª ×‘×¨×™×¨×ª ××—×“×œ
  if (containersSettings.length === 0) {
    containersSettings = [
      { name: '××™×›×œ ×’×“×•×œ', volume: 10 },
      { name: '××™×›×œ ×‘×™× ×•× ×™', volume: 5 },
      { name: '××™×›×œ ×§×˜×Ÿ', volume: 2 }
    ];
    saveContainersSettings(containersSettings);
  }
  
  // ×˜×¢×™× ×ª ××•×¦×¨×™× ××”× ×ª×•× ×™× ×”× ××©×›×™× - ×¢×‘×•×“×” ×¢× ××‘× ×” NoSQL
  if (currentStructuredData && Object.keys(currentStructuredData).length > 0) {
    // ×¢×‘×•×“×” ×¢× ××‘× ×” NoSQL
    Object.values(currentStructuredData).forEach(order => {
      order.items.forEach(item => {
        const partName = item.partName || '';
        if (partName && !productsSettings[partName]) {
          productsSettings[partName] = {
            partName: partName,
            partDes: item.partDes || '',
            calcType: 'weight', // 'weight' ××• 'servings'
            value: 1 // ××©×§×œ/× ×¤×— ××• ××©×§×œ ×œ×× ×”
          };
        }
      });
    });
    saveProductsSettings(productsSettings);
  } else if (currentData && currentData.length > 0) {
    // fallback ×œ××‘× ×” ×©×˜×•×—
    currentData.forEach(row => {
      const partName = row.PARTNAME || '';
      if (partName && !productsSettings[partName]) {
        productsSettings[partName] = {
          partName: partName,
          partDes: row.PARTDES || '',
          calcType: 'weight', // 'weight' ××• 'servings'
          value: 1 // ××©×§×œ/× ×¤×— ××• ××©×§×œ ×œ×× ×”
        };
      }
    });
    saveProductsSettings(productsSettings);
  }
  
  displayProductsSettings(productsSettings);
  displayContainersSettings(containersSettings);
}

function saveProductsSettings(settings) {
  localStorage.setItem('packingProductsSettings', JSON.stringify(settings));
}

function saveContainersSettings(settings) {
  localStorage.setItem('packingContainersSettings', JSON.stringify(settings));
}

function displayProductsSettings(settings) {
  const tbody = document.getElementById('productsSettingsBody');
  tbody.innerHTML = '';
  
  Object.values(settings).forEach(product => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${product.partName}<br><small>${product.partDes}</small></td>
      <td>
        <select onchange="updateProductSetting('${product.partName}', 'calcType', this.value)">
          <option value="weight" ${product.calcType === 'weight' ? 'selected' : ''}>××§×œ (××©×§×œ/× ×¤×—)</option>
          <option value="servings" ${product.calcType === 'servings' ? 'selected' : ''}>×—××©×‘×¢</option>
        </select>
      </td>
      <td>
        <input type="number" step="0.01" value="${product.value}" 
               onchange="updateProductSetting('${product.partName}', 'value', this.value)"
               style="width:100px;">
      </td>
      <td><button class="btn" onclick="deleteProductSetting('${product.partName}')">××—×§</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function displayContainersSettings(settings) {
  const tbody = document.getElementById('containersSettingsBody');
  tbody.innerHTML = '';
  
  settings.forEach((container, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${container.name}" 
                 onchange="updateContainerSetting(${index}, 'name', this.value)" style="width:150px;"></td>
      <td><input type="number" step="0.1" value="${container.volume}" 
                 onchange="updateContainerSetting(${index}, 'volume', this.value)" style="width:100px;"> ×œ×™×˜×¨</td>
      <td><button class="btn" onclick="deleteContainerSetting(${index})">××—×§</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function updateProductSetting(partName, field, value) {
  let settings = JSON.parse(localStorage.getItem('packingProductsSettings') || '{}');
  if (settings[partName]) {
    settings[partName][field] = field === 'value' ? parseFloat(value) : value;
    saveProductsSettings(settings);
    displayProductsSettings(settings);
  }
}

function updateContainerSetting(index, field, value) {
  let settings = JSON.parse(localStorage.getItem('packingContainersSettings') || '[]');
  if (settings[index]) {
    settings[index][field] = field === 'volume' ? parseFloat(value) : value;
    saveContainersSettings(settings);
    displayContainersSettings(settings);
  }
}

function deleteProductSetting(partName) {
  if (confirm(`×”×× ×œ××—×•×§ ××ª ×”×”×’×“×¨×” ×¢×‘×•×¨ ${partName}?`)) {
    let settings = JSON.parse(localStorage.getItem('packingProductsSettings') || '{}');
    delete settings[partName];
    saveProductsSettings(settings);
    displayProductsSettings(settings);
  }
}

function deleteContainerSetting(index) {
  if (confirm('×”×× ×œ××—×•×§ ××ª ×”××™×›×œ?')) {
    let settings = JSON.parse(localStorage.getItem('packingContainersSettings') || '[]');
    settings.splice(index, 1);
    saveContainersSettings(settings);
    displayContainersSettings(settings);
  }
}

function addContainer() {
  let settings = JSON.parse(localStorage.getItem('packingContainersSettings') || '[]');
  settings.push({ name: '××™×›×œ ×—×“×©', volume: 1 });
  saveContainersSettings(settings);
  displayContainersSettings(settings);
}

// ×—×™×©×•×‘ ××•×¤×˜×™××™×–×¦×™×” ×œ×¤×™ ××§×œ (××©×§×œ/× ×¤×—)
function calculatePackingByWeight(totalWeight, weightPerLiter, containers) {
  // ××™×•×Ÿ ××™×›×œ×™× ××”×’×“×•×œ ×œ×§×˜×Ÿ
  const sortedContainers = [...containers].sort((a, b) => b.volume - a.volume);
  
  // ×—×™×©×•×‘ × ×¤×— × ×“×¨×©
  const requiredVolume = totalWeight / weightPerLiter;
  
  const result = {
    totalWeight: totalWeight,
    requiredVolume: requiredVolume,
    containers: []
  };
  
  let remainingVolume = requiredVolume;
  
  // ×—×œ×•×§×” ×œ××™×›×œ×™× ××”×’×“×•×œ ×œ×§×˜×Ÿ
  for (let i = 0; i < sortedContainers.length && remainingVolume > 0.01; i++) {
    const container = sortedContainers[i];
    const count = Math.floor(remainingVolume / container.volume);
    
    if (count > 0 || (i === sortedContainers.length - 1 && remainingVolume > 0)) {
      // ×× ×–×” ×”××™×›×œ ×”××—×¨×•×Ÿ, × ×•×¡×™×£ ×’× ××ª ×”×©××¨×™×ª
      const finalCount = i === sortedContainers.length - 1 ? 
        Math.ceil(remainingVolume / container.volume) : count;
      
      result.containers.push({
        name: container.name,
        volume: container.volume,
        count: finalCount,
        totalVolume: finalCount * container.volume
      });
      
      remainingVolume -= finalCount * container.volume;
    }
  }
  
  result.waste = Math.max(0, result.containers.reduce((sum, c) => sum + c.totalVolume, 0) - requiredVolume);
  return result;
}

// ×—×™×©×•×‘ ××•×¤×˜×™××™×–×¦×™×” ×œ×¤×™ ×—××©×‘×¢ (5 ×•-7 ×× ×•×ª)
function optimizeServings(totalServings) {
  // ×¢×™×’×•×œ ×œ××¡×¤×¨ ×©×œ×
  const target = Math.round(totalServings);
  
  if (target <= 0) {
    return { five: 0, seven: 0, waste: 0 };
  }
  
  // × ×¡×” ×›×œ ×©×™×œ×•×‘ ××¤×©×¨×™ ×©×œ 5 ×•-7 ×× ×•×ª
  let bestSolution = { five: 0, seven: 0, waste: target };
  
  // × ×¡×” ×œ×›×œ ×›××•×ª ×©×œ 7 ×× ×•×ª (×-0 ×¢×“ ×”××§×¡×™××•× ×”××¤×©×¨×™)
  const maxSevens = Math.ceil(target / 7);
  
  for (let seven = 0; seven <= maxSevens; seven++) {
    const usedBySevens = seven * 7;
    const remaining = target - usedBySevens;
    
    if (remaining === 0) {
      // ×¤×ª×¨×•×Ÿ ××•×©×œ× - ×‘×“×™×•×§ ××” ×©×¦×¨×™×š!
      bestSolution = { five: 0, seven: seven, waste: 0 };
      break; // ×–×” ×”×¤×ª×¨×•×Ÿ ×”×˜×•×‘ ×‘×™×•×ª×¨, ××™×Ÿ ×¦×•×¨×š ×œ×”××©×™×š
    }
    
    if (remaining < 0) {
      // ×™×•×ª×¨ ××“×™ ×××¨×–×™ 7 - × ×—×©×‘ ××ª ×”×¤×—×ª
      const waste = Math.abs(remaining);
      if (waste < bestSolution.waste) {
        bestSolution = { five: 0, seven: seven, waste: waste };
      }
      continue;
    }
    
    // × ×¡×” ×¢× ×××¨×–×™ 5 - ×¤×—×•×ª ×××” ×©×¦×¨×™×š (×¤×—×ª - ×—×¡×¨)
    const fiveFloor = Math.floor(remaining / 5);
    const leftover = remaining - (fiveFloor * 5);
    
    if (leftover < bestSolution.waste || 
        (leftover === bestSolution.waste && fiveFloor + seven < bestSolution.five + bestSolution.seven)) {
      bestSolution = { five: fiveFloor, seven: seven, waste: leftover };
    }
    
    // × ×¡×” ×’× ×¢× ×××¨×– 5 × ×•×¡×£ (×™×•×ª×¨ ×××” ×©×¦×¨×™×š - ×¤×—×ª - ×¢×•×“×£)
    if (remaining % 5 !== 0) {
      const fiveCeil = Math.ceil(remaining / 5);
      const excess = (fiveCeil * 5) - remaining;
      
      if (excess < bestSolution.waste || 
          (excess === bestSolution.waste && fiveCeil + seven < bestSolution.five + bestSolution.seven)) {
        bestSolution = { five: fiveCeil, seven: seven, waste: excess };
      }
    }
  }
  
  return bestSolution;
}

// ×—×™×©×•×‘ ××•×¤×˜×™××™×–×¦×™×” ×›×œ×œ×™
function calculatePacking() {
  if (!currentStructuredData || Object.keys(currentStructuredData).length === 0) {
    if (!currentData || currentData.length === 0) {
      alert('××™×Ÿ × ×ª×•× ×™× ×œ×—×™×©×•×‘. ×× × ××©×•×š × ×ª×•× ×™× ×§×•×“×.');
      return;
    }
  }
  
  const productsSettings = JSON.parse(localStorage.getItem('packingProductsSettings') || '{}');
  const containersSettings = JSON.parse(localStorage.getItem('packingContainersSettings') || '[]');
  
  if (Object.keys(productsSettings).length === 0) {
    alert('××™×Ÿ ×”×’×“×¨×•×ª ××•×¦×¨×™×. ×× × ×”×’×“×¨ ××•×¦×¨×™× ×ª×—×™×œ×”.');
    return;
  }
  
  if (containersSettings.length === 0) {
    alert('××™×Ÿ ×”×’×“×¨×•×ª ××™×›×œ×™×. ×× × ×”×’×“×¨ ××™×›×œ×™× ×ª×—×™×œ×”.');
    return;
  }
  
  // ×§×™×‘×•×¥ × ×ª×•× ×™× ×œ×¤×™ ×¤×¨×™×˜ - ×¢×‘×•×“×” ×¢× ××‘× ×” NoSQL
  const productsData = {};
  
  if (currentStructuredData && Object.keys(currentStructuredData).length > 0) {
    // ×¢×‘×•×“×” ×¢× ××‘× ×” NoSQL
    Object.values(currentStructuredData).forEach(order => {
      order.items.forEach(item => {
        const partName = item.partName || '';
        if (partName && productsSettings[partName]) {
          if (!productsData[partName]) {
            productsData[partName] = {
              partName: partName,
              partDes: item.partDes || '',
              totalQuantity: 0
            };
          }
          productsData[partName].totalQuantity += parseFloat(item.pritGenQuant) || 0;
        }
      });
    });
  } else {
    // fallback ×œ××‘× ×” ×©×˜×•×—
    currentData.forEach(row => {
      const partName = row.PARTNAME || '';
      if (partName && productsSettings[partName]) {
        if (!productsData[partName]) {
          productsData[partName] = {
            partName: partName,
            partDes: row.PARTDES || '',
            totalQuantity: 0
          };
        }
        productsData[partName].totalQuantity += parseFloat(row.PRIT_GENQUANT) || 0;
      }
    });
  }
  
  // ×—×™×©×•×‘ ×œ×›×œ ××•×¦×¨
  const results = [];
  
  Object.values(productsData).forEach(product => {
    const setting = productsSettings[product.partName];
    let result = {
      partName: product.partName,
      partDes: product.partDes,
      totalQuantity: product.totalQuantity,
      calcType: setting.calcType,
      details: null
    };
    
    if (setting.calcType === 'weight') {
      // ×—×™×©×•×‘ ×œ×¤×™ ××§×œ
      result.details = calculatePackingByWeight(
        product.totalQuantity,
        setting.value,
        containersSettings
      );
    } else {
      // ×—×™×©×•×‘ ×œ×¤×™ ×—××©×‘×¢
      const servingsPerUnit = setting.value;
      const totalServings = product.totalQuantity / servingsPerUnit;
      const optimized = optimizeServings(totalServings);
      
      result.details = {
        totalServings: totalServings,
        fiveCount: optimized.five,
        sevenCount: optimized.seven,
        waste: optimized.waste
      };
    }
    
    results.push(result);
  });
  
  // ×”×¦×’×ª ×ª×•×¦××•×ª
  displayPackingResults(results);
  window.packingResults = results;
}

function displayPackingResults(results) {
  const container = document.getElementById('packingResultsContainer');
  
  let html = '<table><thead><tr>';
  html += '<th>××§×˜</th><th>×ª×™××•×¨</th><th>×›××•×ª ×›×•×œ×œ×ª</th><th>×¡×•×’ ×—×™×©×•×‘</th><th>×ª×•×¦××•×ª</th>';
  html += '</tr></thead><tbody>';
  
  results.forEach(result => {
    html += '<tr>';
    html += `<td>${result.partName}</td>`;
    html += `<td>${result.partDes}</td>`;
    html += `<td>${result.totalQuantity.toFixed(2)}</td>`;
    html += `<td>${result.calcType === 'weight' ? '××§×œ' : '×—××©×‘×¢'}</td>`;
    
    if (result.calcType === 'weight') {
      html += '<td>';
      html += `<strong>× ×¤×— × ×“×¨×©:</strong> ${result.details.requiredVolume.toFixed(2)} ×œ×™×˜×¨<br>`;
      result.details.containers.forEach(c => {
        html += `${c.name} (${c.volume}×œ): ${c.count} ×™×—×™×“×•×ª<br>`;
      });
      html += `<strong>×¤×—×ª:</strong> ${result.details.waste.toFixed(2)} ×œ×™×˜×¨`;
      html += '</td>';
    } else {
      html += '<td>';
      html += `<strong>×¡×”"×› ×× ×•×ª:</strong> ${result.details.totalServings.toFixed(0)}<br>`;
      html += `<strong>×××¨×–×™ 5 ×× ×•×ª:</strong> ${result.details.fiveCount}<br>`;
      html += `<strong>×××¨×–×™ 7 ×× ×•×ª:</strong> ${result.details.sevenCount}<br>`;
      html += `<strong>×¤×—×ª:</strong> ${result.details.waste} ×× ×•×ª`;
      html += '</td>';
    }
    
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function downloadPackingCSV() {
  if (!window.packingResults || window.packingResults.length === 0) {
    alert('××™×Ÿ ×ª×•×¦××•×ª ×œ×”×•×¨×“×”');
    return;
  }
  
  let csv = '\uFEFF××§×˜,×ª×™××•×¨,×›××•×ª ×›×•×œ×œ×ª,×¡×•×’ ×—×™×©×•×‘,×ª×•×¦××•×ª\n';
  
  window.packingResults.forEach(result => {
    let resultText = '';
    if (result.calcType === 'weight') {
      resultText = `× ×¤×—: ${result.details.requiredVolume.toFixed(2)}×œ; `;
      result.details.containers.forEach(c => {
        resultText += `${c.name}:${c.count}; `;
      });
      resultText += `×¤×—×ª:${result.details.waste.toFixed(2)}×œ`;
    } else {
      resultText = `×× ×•×ª:${result.details.totalServings.toFixed(0)}; 5:${result.details.fiveCount}; 7:${result.details.sevenCount}; ×¤×—×ª:${result.details.waste}`;
    }
    
    csv += `"${result.partName}","${result.partDes}",${result.totalQuantity.toFixed(2)},${result.calcType === 'weight' ? '××§×œ' : '×—××©×‘×¢'},"${resultText}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `packing_optimization_${document.getElementById('dateInput').value}.csv`;
  link.click();
}

// ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ×›×©××©× ×™× ×˜××‘
const originalShowTab = showTab;
window.showTab = function(tabName, button) {
  // ×”×¡×ª×¨×ª ×›×œ ×”×ª×•×›×Ÿ
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // ×”×¦×’×ª ×”×˜××‘ ×”× ×‘×—×¨
  document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
  if (button) {
    button.classList.add('active');
  }
  
  // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª ××¨×™×–×” ×× ×¦×¨×™×š
  if (tabName === 'packing') {
    loadPackingSettings();
  }
};
</script>

<!-- jQuery and DataTables -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

</body>
</html>

