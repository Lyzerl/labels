# סיכום פרויקט - מערכת דוחות Priority ERP

## 📋 תיאור כללי

זהו פרויקט **Single Page Application (SPA)** ב-HTML/CSS/JavaScript שמתחבר למערכת Priority ERP דרך Cloudflare Worker, שולף נתוני הזמנות, ומציג אותם במגוון דוחות מותאמים לצרכי אריזה והפצה.

המערכת מיועדת לניהול הזמנות מזון, חישובי אריזה, והדפסת מדבקות עם זיהוי פריטים אלרגניים וצמחוניים.

---

## 🏗️ ארכיטקטורה ומבנה

### קבצים
- **`index.html`** - קובץ יחיד המכיל את כל הקוד (HTML, CSS, JavaScript)
- **גודל הקובץ:** ~4,082 שורות
- **טכנולוגיות:**
  - Vanilla JavaScript (ללא frameworks)
  - DataTables.js (לטבלאות מתקדמות)
  - Cloudflare Worker (כפרוקסי ל-Priority API)

### מבנה הנתונים

המערכת עובדת עם **שני מבני נתונים**:

1. **מבנה שטוח (Flat)** - `currentData`
   - מערך של שורות, כל שורה = פריט בהזמנה
   - משמש לטבלה הכללית

2. **מבנה NoSQL (מובנה)** - `currentStructuredData`
   - אובייקט שבו המפתח = מספר הזמנה (`ORDNAME`)
   - כל הזמנה מכילה:
     - פרטי הזמנה (לקוח, כתובת, תאריך, וכו')
     - מערך `items[]` של כל הפריטים בהזמנה
   - משמש לדוחות המתקדמים (מדבקות, חמגשיות, וכו')

**פונקציית המרה:** `organizeAsNoSQL(rawData)` - ממירה מבנה שטוח למבנה NoSQL

---

## 🔌 חיבור לשרת

### Cloudflare Worker
- **URL:** `https://priority-proxy.lyzer-64d.workers.dev`
- **פורמט בקשה:** `GET ?filter=<OData Filter>`
- **פילטרים:**
  - `DUEDATE eq YYYY-MM-DDT00:00:00Z` - תאריך אספקה
  - `BRANCHNAME le '1'` - סניף דרום
  - `BRANCHNAME ge '3'` - סניף צפון

### Pagination
- **גודל דף:** 100 רשומות
- **מקסימום דפים:** 400 (40,000 רשומות)
- **מנגנון:** `$top` ו-`$skip` של OData

---

## 📊 שדות נתונים (SELECTED_FIELDS)

המערכת שולפת **26 שדות** מהמערכת:

### שדות הזמנה:
- `ORDNAME` - מספר הזמנה
- `DUEDATE` - תאריך אספקה
- `BRANCHNAME` - סניף
- `CUSTNAME`, `CUSTDES` - פרטי לקוח
- `SPEC1`, `SPEC2` - סוג לקוח וכשרות
- `ADDRESS`, `STATE`, `PHONENUM` - פרטי כתובת
- `DISTRLINECODE`, `DISTRLINEDES` - קו חלוקה
- `PRIT_DISTRORDER` - סדר הפצה

### שדות פריט:
- `PARTNAME`, `PARTDES` - מקט ותיאור מוצר
- `PSPEC1`, `PSPEC2`, `PSPEC3`, `PSPEC6` - פרמטרים למוצר
- `PACKMETHODCODE`, `PACKDES` - שיטת אריזה
- `EATQUANT` - מספר מנות
- `TQUANT` - כמות (ק"ג)
- `MEALNAME` - שם ארוחה

### שדות חישוב:
- `Y_9964_5_ESH` - פרמטר 7 (לחישוב מיכלים)
- `Y_9965_5_ESH` - פרמטר 8 (לחישוב מארז 5/7)
- `Y_37210_5_ESH` - סוג קרטון (חם/קר)
- `CONTAINERS`, `PACK5`, `PACK7` - שדות מחושבים

---

## 🧮 חישובים אוטומטיים

### פונקציה: `calculateContainersAndPacks(data)`

**חשוב:** הפונקציה יוצרת **עותק** של הנתונים ולא משנה את המקוריים!

#### חישוב מיכלים (CONTAINERS):
```javascript
if (Y_9964_5_ESH > 0) {
  CONTAINERS = Math.ceil((TQUANT / Y_9964_5_ESH) / 2)
}
```
- מחלקים את המשקל בפרמטר 7
- מחלקים ב-2
- מעגלים כלפי מעלה

#### חישוב מארז 5/7 (PACK5, PACK7):
```javascript
if (Y_9965_5_ESH > 0) {
  totalServings = Math.ceil(TQUANT / Y_9965_5_ESH)  // עגול כלפי מעלה!
  optimized = optimizeServings(totalServings)
  PACK5 = optimized.five
  PACK7 = optimized.seven
}
```

### פונקציה: `optimizeServings(totalServings)`

**מטרה:** מציאת השילוב האופטימלי של מארז 5 ומארז 7 עם מינימום פסולת.

**אלגוריתם:**
1. **עדיפות ראשונה:** פתרון מושלם (waste = 0)
2. **עדיפות שנייה:** פתרון עם עודף קטן (עדיף על חסר)
3. **עדיפות שלישית:** פתרון עם חסר קטן

**דוגמה:**
- 31 מנות → 3x7 + 2x5 = 31 (מושלם)
- לא: 5x5 + 1x7 = 32 (עודף)

---

## 📑 דוחות

המערכת כוללת **5 דוחות עיקריים**:

### 1. 📋 טבלה כללית (General Table)

**מטרה:** הצגת כל הנתונים הגולמיים כמו שהם מגיעים מ-Priority.

**תכונות:**
- DataTables עם חיפוש וסינון לכל עמודה
- גלילה אופקית ואנכית מלאה
- ייצוא CSV
- **חשוב:** הנתונים מוצגים **בדיוק** כמו שהם מגיעים מ-Priority, ללא שינויים

**פונקציה:** `createTable(data)`

### 2. ❄️ דוח אריזה קרה (Cold Packing Report)

**מטרה:** סיכום פריטים לקר לפי קטגוריה.

**סינונים:**
- סניף (דרום/צפון/הכל)
- קטגוריה (PSPEC6) - הכל / רק לא ריק

**עמודות:**
- לפי קטגוריה
- תיאור מוצר
- ס"ה מנות (EATQUANT)
- ס"ה לייצור (TQUANT)

**הערה:** **לא כולל** עמודות "מיכלים" ו-"מארז 5/7"

**פונקציות:**
- `createSummaryReport(data)` - יצירת הדוח
- `applySummaryFilters()` - סינון מיידי (ללא כפתור "החל")
- `downloadSummaryCSV()` - ייצוא CSV

### 3. 🔥 דוח אריזה חמה (Hot Packing Report)

**מטרה:** סיכום פריטים חמים בלבד, מחולקים לקטגוריות.

**סינונים:**
- סניף (דרום/צפון/הכל)

**קטגוריות:**
1. **חמגשית קטנה** - `PACKMETHODCODE` = "חמגשית 101"
2. **חמגשית גדולה** - `PACKMETHODCODE` = "חמגשית 102"
3. **גסטרונום** - `PACKMETHODCODE` או `PACKDES` מכיל "גסטרונום"
4. **מיכל 1 ליטר** - `PSPEC1` מכיל "1 ליטר"
5. **מיכל 2 ליטר** - `PSPEC1` מכיל "2 ליטר"
6. **מארז 7** - `PACK7 > 0`
7. **מארז 5** - `PACK5 > 0` (ללא מארז 7)

**זיהוי קרטון חם:**
- `CARTON_TYPE` (Y_37210_5_ESH) מכיל "חם" או "חמים"
- או `PSPEC6` מכיל "חם" או "חמים"

**לוגיקה מיוחדת - חמגשיות:**

**חמגשית קטנה/גדולה:**
- קיבוץ לפי הזמנה → ארוחה → פריטים רגילים/אלרגניים
- **חשוב:** אם יש כמה פריטים באותה ארוחה עם אותה כמות (למשל: אורז 10, קוסקוס 10), הכמות נספרת **רק פעם אחת** (10, לא 20)
- פריטים זהים מארוחות שונות **מאוחדים** לשורה אחת
- פריטים אלרגניים מאוחדים בנפרד (עם סימון "ללא אלרגנים")

**מיכלים (תפזורת/סיפט):**
- **רק** פריטים עם `PACKMETHODCODE` או `PACKDES` = "תפזורת" או "סיפט"
- **לא כולל:** "חמגשית" או "גסטרונום"
- אם יש כמה פריטים באותה הזמנה עם אותו `PARTDES` ואותו `CONTAINERS`, נספר **רק פעם אחת** להזמנה

**תכונות נוספות:**
- לחיצה על שורה בחמגשית קטנה/גדולה → הורדת CSV של מספרי הזמנות
- פונקציה: `downloadTrayRowOrdersCSV(rowId, trayType)`

**פונקציות:**
- `createTraysReport(data)` - יצירת הדוח
- `applyTraysFilters()` - סינון מיידי
- `downloadTraysCSV()` - ייצוא CSV

### 4. 🚫 דוח אלרגנים (Allergens Report)

**מטרה:** סיכום מנות ללא אלרגנים לפי סוג לקוח, כשרות, שיטת אריזה, וקו חלוקה.

**זיהוי פריטים ללא אלרגנים:**
- `PSPEC1` מכיל "ללא אלרגני" או "לא אלרגני"
- או `PARTDES` / `PARTNAME` מכיל "ללא אלרגני" או "לא אלרגני"

**קיבוץ:**
- `SPEC1` - סוג לקוח (פרטי/מילגם)
- `SPEC2` - כשרות (בד"ץ/חבד)
- שיטת אריזה (חמגשית/תפזורת/גסטרונום)
- `DISTRLINECODE` - קו חלוקה

**עמודות:**
- קוד קו
- תיאור קו
- סה"כ מנות (EATQUANT)

**פונקציה:** `createAllergensReport(data)`

### 5. 🏷️ דוח מדבקות (Labels Report)

**מטרה:** יצירת מדבקות להדפסה על קרטונים.

**סינונים:**
- קו חלוקה
- סוג מדבקה (הכל/קרים/חמים)
- שיטת אריזה ראשית

**מבנה מדבקה:**

כל מדבקה מכילה:
1. **טבלת מידע ראשי:**
   - תאריך, לקוח, כתובת, קו חלוקה, סדר הפצה
   - כשרות, כמות מנות
   - סוג קרטון (חם/קר)

2. **טבלת פריטים:**
   - תיאור מוצר
   - מארז 7 (רק לקרטון חם)
   - מיכלים / מארז 5 (רק לקרטון חם)
   - כמות

**זיהוי קרטון חם/קר:**
- עדיפות: `CARTON_TYPE` (Y_37210_5_ESH)
- אם לא ברור: `PSPEC6`

**הדגשת פריטים:**
- **פריטים אלרגניים:**
  - זיהוי: `PSPEC2`, `SPEC2`, `PARTDES`, `PARTNAME` מכיל "אלרגני" או "ללא אלרגני"
  - הדגשה: רקע אדום (`#ffcdd2`) לשורה
  - תוספת טקסט: "(ללא אלרגנים)"

- **פריטים צמחוניים:**
  - זיהוי: `PSPEC2`, `SPEC2`, `PARTDES`, `PARTNAME` מכיל "צמחוני" או "טבעוני"
  - הדגשה: רקע ירוק (`#c8e6c9`) לשורה
  - תוספת טקסט: "(צמחוני)"

**ייצוא:**
- **CSV:** `downloadLabelsCSV()` - רשימת הזמנות
- **PDF:** `downloadLabelsPDF()` - מדבקות להדפסה
  - 2 מדבקות לדף A4 (אחת מעל השנייה)
  - CSS מותאם להדפסה
  - שורות מודגשות נשמרות גם ב-PDF

**פונקציות:**
- `createLabelsReport(data)` - יצירת הדוח
- `renderLabelsTableNoSQL(orders, container, labelsMode)` - רינדור מדבקות
- `downloadLabelsPDF()` - יצירת PDF להדפסה

---

## 🎨 ממשק משתמש

### עיצוב
- **רספונסיבי:** מותאם למובייל (media queries)
- **כיוון:** RTL (מימין לשמאל)
- **צבעים:**
  - כחול (#4285f4) - כפתורים ראשיים
  - ירוק (#34a853) - כפתורי הורדה
  - אדום (#ffcdd2) - פריטים אלרגניים
  - ירוק (#c8e6c9) - פריטים צמחוניים

### טאבים
- מעבר בין דוחות דרך טאבים
- כל טאב עם סינונים משלו
- סינונים מיידיים (ללא כפתור "החל")

### DataTables
- חיפוש גלובלי
- סינון לכל עמודה
- גלילה אופקית ואנכית
- ייצוא CSV מובנה

---

## 🔧 פונקציות עיקריות

### ניהול נתונים:
1. `fetchData()` - משיכת נתונים מהשרת עם pagination
2. `organizeAsNoSQL(rawData)` - המרה למבנה NoSQL
3. `calculateContainersAndPacks(data)` - חישוב מיכלים ומארזים

### יצירת דוחות:
4. `createTable(data)` - טבלה כללית
5. `createSummaryReport(data)` - דוח אריזה קרה
6. `createTraysReport(data)` - דוח אריזה חמה
7. `createAllergensReport(data)` - דוח אלרגנים
8. `createLabelsReport(data)` - דוח מדבקות

### סינון:
9. `applySummaryFilters()` - סינון דוח אריזה קרה
10. `applyTraysFilters()` - סינון דוח אריזה חמה

### ייצוא:
11. `downloadCSV()` - ייצוא טבלה כללית
12. `downloadSummaryCSV()` - ייצוא דוח אריזה קרה
13. `downloadTraysCSV()` - ייצוא דוח אריזה חמה
14. `downloadLabelsCSV()` - ייצוא דוח מדבקות (CSV)
15. `downloadLabelsPDF()` - ייצוא דוח מדבקות (PDF)
16. `downloadTrayRowOrdersCSV(rowId, trayType)` - הורדת CSV של הזמנות משורה

### אופטימיזציה:
17. `optimizeServings(totalServings)` - אופטימיזציית מארז 5/7

---

## ⚠️ נקודות חשובות לפיתוח

### 1. שמירה על נתונים מקוריים
- **חשוב מאוד:** הנתונים הגולמיים (`allData`) **לא משתנים**!
- `calculateContainersAndPacks` יוצרת **עותק** של הנתונים
- `organizeAsNoSQL` יוצרת מבנה חדש ולא משנה את המקור

### 2. זיהוי קרטון חם/קר
- **עדיפות:** `CARTON_TYPE` (Y_37210_5_ESH)
- **גיבוי:** `PSPEC6`
- **חשוב:** בדוח אריזה חמה - רק פריטים עם קרטון חם!

### 3. חישוב חמגשיות
- אם יש כמה פריטים באותה ארוחה עם אותה כמות → נספרת **פעם אחת**
- פריטים זהים מארוחות שונות → **מאוחדים**

### 4. חישוב מיכלים
- **רק** תפזורת/סיפט (לא חמגשית/גסטרונום)
- אם יש כמה פריטים זהים באותה הזמנה → נספרת **פעם אחת**

### 5. אופטימיזציית מארז 5/7
- **תמיד** מעגלים את `totalServings` כלפי מעלה לפני האופטימיזציה
- עדיפות: פתרון מושלם (waste = 0)
- עדיפות שנייה: עודף קטן (עדיף על חסר)

### 6. זיהוי אלרגניים/צמחוניים
- חיפוש ב-`PSPEC2`, `SPEC2`, `PARTDES`, `PARTNAME`
- מילות מפתח: "אלרגני", "ללא אלרגני", "צמחוני", "טבעוני"
- הדגשה: רקע צבעוני לשורה בטבלת הפריטים

### 7. PDF Export
- שימוש ב-`window.print()` (לא html2pdf)
- CSS מותאם להדפסה (`@media print`)
- 2 מדבקות לדף A4
- שמירה על הדגשות צבעוניות

---

## 🐛 Debugging

### Console Logs
המערכת כוללת `console.log` רבים לבדיקה:
- נתונים גולמיים לאחר משיכה
- נתונים לאחר חישובים
- דוגמאות להזמנות
- סטטיסטיקות שיטות אריזה

### בדיקות מומלצות:
1. בדיקת כמות רשומות שנמשכו
2. בדיקת חישובי מיכלים ומארזים
3. בדיקת זיהוי קרטון חם/קר
4. בדיקת זיהוי אלרגניים/צמחוניים
5. בדיקת אופטימיזציית מארז 5/7

---

## 📦 תלויות חיצוניות

### CDN Libraries:
1. **DataTables:**
   - `https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js`
   - `https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js`
   - `https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js`

2. **jQuery:**
   - `https://code.jquery.com/jquery-3.7.0.min.js`

### CSS:
- DataTables CSS (מ-CDN)
- כל ה-CSS מוגדר ב-`<style>` בתוך הקובץ

---

## 🔐 אבטחה

- **אין אבטחה מובנית** - המערכת פועלת דרך Cloudflare Worker
- **אין אימות משתמשים** - כל מי שיש לו גישה לקובץ יכול להשתמש
- **נתונים:** כל הנתונים נשלפים מ-Priority דרך הפרוקסי

---

## 🚀 הפעלה

1. פתח את `index.html` בדפדפן
2. בחר תאריך אספקה
3. בחר סניף (אופציונלי)
4. לחץ "משוך נתונים"
5. המתן לטעינה (עם pagination)
6. בחר טאב לדוח הרצוי
7. השתמש בסינונים (מיידיים)
8. הורד CSV/PDF לפי הצורך

---

## 📝 הערות נוספות

### מבנה נתונים NoSQL:
```javascript
{
  "ORDNAME123": {
    orderName: "ORDNAME123",
    dueDate: "2025-11-25",
    branchName: "דרום",
    custDes: "שם לקוח",
    items: [
      {
        partName: "PART001",
        partDes: "תיאור מוצר",
        tQuant: 10.5,
        containers: 2,
        pack5: 1,
        pack7: 2,
        // ... עוד שדות
      }
    ]
  }
}
```

### משתנים גלובליים:
- `currentData` - נתונים שטוחים (לפני חישובים)
- `currentStructuredData` - נתונים מובנים (NoSQL)
- `dataTable` - אובייקט DataTables (לניקוי בעת יצירת טבלה חדשה)

---

## 📞 תמיכה

לשאלות או בעיות:
1. בדוק את ה-console בדפדפן (F12)
2. בדוק את ה-network tab (בדיקת בקשות לשרת)
3. בדוק את ה-`console.log` בקוד

---

**תאריך עדכון אחרון:** 2025-11-25  
**גרסה:** 1.0  
**מפתח:** Lyzer

